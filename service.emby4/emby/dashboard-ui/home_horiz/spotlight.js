define(["visibleinviewport","itemShortcuts","browser","connectionManager"],function(visibleinviewport,itemShortcuts,browser,connectionManager){"use strict";function loadItemIntoSpotlight(card,item,width){if(item.BackdropImageTags&&item.BackdropImageTags.length){document.activeElement===card&&card.dispatchEvent(new CustomEvent("focus"));var imgUrl=function(item,options){return(options=options||{}).type=options.type||"Backdrop",options.maxWidth||options.width||options.maxHeight||options.height||(options.quality=100),item.BackdropImageTags&&item.BackdropImageTags.length?(options.tag=item.BackdropImageTags[0],connectionManager.getApiClient(item.ServerId).getScaledImageUrl(item.Id,options)):null}(item,{maxWidth:width}),cardImageContainer=card.querySelector(".cardImage"),newCardImageContainer=document.createElement("div");newCardImageContainer.className=cardImageContainer.className,newCardImageContainer.style.backgroundImage="url('"+imgUrl+"')",card.querySelector(".cardText").innerHTML=item.Name;for(var attributes=itemShortcuts.getShortcutAttributes(item,{}),i=0,length=attributes.length;i<length;i++)card.setAttribute(attributes[i].name,attributes[i].value);card.setAttribute("data-action","link"),card.classList.add("itemAction"),cardImageContainer.parentNode.appendChild(newCardImageContainer);var onAnimationFinished=function(){var parentNode=cardImageContainer.parentNode;parentNode&&parentNode.removeChild(cardImageContainer)};if(browser.animate){newCardImageContainer.animate([{opacity:"0",offset:0},{opacity:"1",offset:1}],{duration:900,iterations:1}).onfinish=onAnimationFinished}else onAnimationFinished()}}function spotlight(card,items,width){itemShortcuts.on(card),this.items=items,this.card=card,this.width=width,this.start()}return spotlight.prototype.start=function(){var items=this.items,card=this.card,width=this.width;if(items.length&&(loadItemIntoSpotlight(card,items[0],width),1!==items.length&&!browser.slow)){this.index=1;var intervalMs=browser.animate?1e4:3e4;this.interval=setInterval(this.onInterval.bind(this),intervalMs)}},spotlight.prototype.onInterval=function(){var items=this.items,card=this.card,width=this.width;document.body.contains(card)?visibleinviewport(card,!1,0)&&(this.index>=items.length&&(this.index=0),loadItemIntoSpotlight(card,items[this.index],width),this.index++):clearInterval(this.interval)},spotlight.prototype.destroy=function(){itemShortcuts.off(this.card),this.interval&&clearInterval(this.interval),this.interval=null,this.items=null,this.card=null},spotlight});