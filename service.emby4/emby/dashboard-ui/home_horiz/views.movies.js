define(["connectionManager","dom","globalize","./spotlight","imageLoader","focusManager","cardBuilder","emby-itemscontainer"],function(connectionManager,dom,globalize,spotlight,imageLoader,focusManager,cardbuilder){"use strict";function getRecommendationHtml(recommendation){var cardsHtml=cardbuilder.getCardsHtml(recommendation.Items,{shape:"portrait",rows:2,scalable:!1}),html="",title="";switch(recommendation.RecommendationType){case"SimilarToRecentlyPlayed":title=globalize.translate("BecauseYouWatchedValue",recommendation.BaselineItemName);break;case"SimilarToLikedItem":title=globalize.translate("BecauseYouLikeValue",recommendation.BaselineItemName);break;case"HasDirectorFromRecentlyPlayed":case"HasLikedDirector":title=globalize.translate("DirectedByValue",recommendation.BaselineItemName);break;case"HasActorFromRecentlyPlayed":case"HasLikedActor":title=globalize.translate("StarringValue",recommendation.BaselineItemName)}return html+='<div class="horizontalSection">',html+='<div class="sectionTitle">'+title+"</div>",html+='<div is="emby-itemscontainer" class="itemsContainer">',html+=cardsHtml,html+="</div>",html+="</div>"}function backdropImageUrl(item,options){return(options=options||{}).type=options.type||"Backdrop",options.maxWidth||options.width||options.maxHeight||options.height||(options.quality=100),item.BackdropImageTags&&item.BackdropImageTags.length?(options.tag=item.BackdropImageTags[0],connectionManager.getApiClient(item.ServerId).getScaledImageUrl(item.Id,options)):null}return function(element,apiClient,parentId,autoFocus){var self=this;this.parentId=parentId,this.apiClient=apiClient,this.latestItemsContainer=element.querySelector(".latestSection .itemsContainer"),this.latestItemsContainer.fetchData=function(){var options={IncludeItemTypes:"Movie",Limit:12,ParentId:this.parentId,EnableImageTypes:"Primary,Backdrop,Thumb",Fields:"PrimaryImageAspectRatio,ProductionYear,CommunityRating",ImageTypeLimit:1,EnableTotalRecordCount:!1};return this.apiClient.getLatestItems(options)}.bind(this),this.latestItemsContainer.getItemsHtml=function(items){return cardbuilder.getCardsHtml({items:items,shape:"portrait",rows:2,scalable:!1})}.bind(this),this.latestItemsContainer.parentContainer=dom.parentWithClass(this.latestItemsContainer,"horizontalSection"),this.resumeItemsContainer=element.querySelector(".resumeSection .itemsContainer"),this.resumeItemsContainer.fetchData=function(){var options={IncludeItemTypes:"Movie",Limit:6,ParentId:this.parentId,ImageTypeLimit:1,EnableImageTypes:"Primary,Backdrop,Thumb",EnableTotalRecordCount:!1},apiClient=this.apiClient;return apiClient.getResumableItems(apiClient.getCurrentUserId(),options)}.bind(this),this.resumeItemsContainer.getItemsHtml=function(items){return cardbuilder.getCardsHtml({items:items,shape:"backdrop",rows:3,preferThumb:!0,scalable:!1})}.bind(this),this.resumeItemsContainer.parentContainer=dom.parentWithClass(this.resumeItemsContainer,"horizontalSection"),autoFocus&&focusManager.autoFocus(element),self.loadData=function(refresh){var promises=[this.resumeItemsContainer.resume({refresh:refresh}),this.latestItemsContainer.resume({refresh:refresh})];return refresh&&promises.push(function(element,apiClient){return apiClient.getMovieRecommendations({categoryLimit:4,ItemLimit:8,UserId:apiClient.getCurrentUserId(),ImageTypeLimit:1,Fields:"PrimaryImageAspectRatio,ProductionYear,CommunityRating"}).then(function(recommendations){var values=recommendations.map(getRecommendationHtml),recs=element.querySelector(".recommendations");recs&&(recs.innerHTML='<div class="horizontalSectionsContainer">'+values.join("")+"</div>",imageLoader.lazyChildren(recs))})}(element,apiClient)),Promise.all(promises)},function(instance,element,parentId){var options={SortBy:"Random",IncludeItemTypes:"Movie",Limit:20,Recursive:!0,ParentId:parentId,EnableImageTypes:"Backdrop",ImageTypes:"Backdrop",Fields:"Taglines,ProductionYear,CommunityRating",ImageTypeLimit:1},apiClient=instance.apiClient;apiClient.getItems(apiClient.getCurrentUserId(),options).then(function(result){var card=element.querySelector(".wideSpotlightCard");instance.spotlight=new spotlight(card,result.Items,767)})}(self,element,parentId),function(element,apiClient,parentId){apiClient.getItems(apiClient.getCurrentUserId(),{SortBy:"IsFavoriteOrLiked,Random",SortOrder:"Descending",IncludeItemTypes:"BoxSet",Limit:1,Recursive:!0,ParentId:parentId,EnableImageTypes:"Backdrop",ImageTypes:"Backdrop",Fields:"PrimaryImageAspectRatio,ProductionYear,CommunityRating",ImageTypeLimit:1}).then(function(result){var items=result.Items;0<items.length&&(element.querySelector(".movieCollectionsCard .cardImage").style.backgroundImage="url('"+backdropImageUrl(items[0],{maxWidth:600})+"')")}),apiClient.getItems(apiClient.getCurrentUserId(),{SortBy:"IsFavoriteOrLiked,Random",SortOrder:"Descending",IncludeItemTypes:"Movie",Limit:2,Recursive:!0,ParentId:parentId,EnableImageTypes:"Backdrop",ImageTypes:"Backdrop",Fields:"PrimaryImageAspectRatio,ProductionYear,CommunityRating",ImageTypeLimit:1}).then(function(result){var items=result.Items,imgOptions={maxWidth:600};0<items.length&&(element.querySelector(".movieFavoritesCard .cardImage").style.backgroundImage="url('"+backdropImageUrl(items[0],imgOptions)+"')"),1<items.length&&(element.querySelector(".allMoviesCard .cardImage").style.backgroundImage="url('"+backdropImageUrl(items[1],imgOptions)+"')")})}(element,apiClient,parentId),element.querySelector(".allMoviesCard").addEventListener("click",function(){Emby.Page.show("/movies?serverId="+apiClient.serverId()+"&parentId="+parentId)}),element.querySelector(".movieCollectionsCard").addEventListener("click",function(){Emby.Page.show("/movies?serverId="+apiClient.serverId()+"&tab=3&parentId="+parentId)}),element.querySelector(".movieFavoritesCard").addEventListener("click",function(){Emby.Page.show("/movies?serverId="+apiClient.serverId()+"&tab=4&parentId="+parentId)}),self.onPause=function(){self.latestItemsContainer.pause(),self.resumeItemsContainer.pause()},self.destroy=function(){self.spotlight&&(self.spotlight.destroy(),self.spotlight=null),self.latestItemsContainer=null,self.resumeItemsContainer=null,self.apiClient=null}}});