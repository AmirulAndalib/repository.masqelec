define(["connectionManager","dom","globalize","./spotlight","imageLoader","focusManager","cardBuilder","emby-itemscontainer"],function(connectionManager,dom,globalize,spotlight,imageLoader,focusManager,cardbuilder){"use strict";function backdropImageUrl(item,options){return(options=options||{}).type=options.type||"Backdrop",options.maxWidth||options.width||options.maxHeight||options.height||(options.quality=100),item.BackdropImageTags&&item.BackdropImageTags.length?(options.tag=item.BackdropImageTags[0],connectionManager.getApiClient(item.ServerId).getScaledImageUrl(item.Id,options)):null}return function(element,apiClient,parentId,autoFocus){var self=this;this.parentId=parentId,this.apiClient=apiClient,this.latestItemsContainer=element.querySelector(".latestSection .itemsContainer"),this.latestItemsContainer.fetchData=function(){var options={IncludeItemTypes:"Episode",Limit:12,ParentId:this.parentId,EnableImageTypes:"Primary,Backdrop,Thumb",Fields:"PrimaryImageAspectRatio,ProductionYear,CommunityRating",ImageTypeLimit:1};return this.apiClient.getLatestItems(options)}.bind(this),this.latestItemsContainer.getItemsHtml=function(items){return cardbuilder.getCardsHtml({items:items,shape:"backdrop",rows:3,preferThumb:!0,showGroupCount:!0})}.bind(this),this.latestItemsContainer.parentContainer=dom.parentWithClass(this.latestItemsContainer,"horizontalSection"),this.resumeItemsContainer=element.querySelector(".resumeSection .itemsContainer"),this.resumeItemsContainer.fetchData=function(){var options={Limit:6,ParentId:this.parentId,ImageTypeLimit:1,EnableImageTypes:"Primary,Backdrop,Thumb"},apiClient=this.apiClient;return apiClient.getResumableItems(apiClient.getCurrentUserId(),options)}.bind(this),this.resumeItemsContainer.getItemsHtml=function(items){return cardbuilder.getCardsHtml({items:items,shape:"backdrop",rows:3,preferThumb:!0,scalable:!1,seriesNameInPlaceHolderName:!0})}.bind(this),this.resumeItemsContainer.parentContainer=dom.parentWithClass(this.resumeItemsContainer,"horizontalSection"),this.nextUpItemsContainer=element.querySelector(".nextUpSection .itemsContainer"),this.nextUpItemsContainer.fetchData=function(){var apiClient=this.apiClient,options={Fields:"PrimaryImageAspectRatio,ProductionYear,CommunityRating",EnableImageTypes:"Primary,Backdrop,Thumb",ImageTypeLimit:1,Limit:18,ParentId:this.parentId,UserId:apiClient.getCurrentUserId(),EnableTotalRecordCount:!1};return apiClient.getNextUpEpisodes(options)}.bind(this),this.nextUpItemsContainer.getItemsHtml=function(items){return cardbuilder.getCardsHtml({items:items,shape:"backdrop",rows:3,preferThumb:!0,seriesNameInPlaceHolderName:!0})}.bind(this),this.nextUpItemsContainer.parentContainer=dom.parentWithClass(this.nextUpItemsContainer,"horizontalSection"),autoFocus&&focusManager.autoFocus(element),self.loadData=function(refresh){var promises=[this.resumeItemsContainer.resume({refresh:refresh}),this.nextUpItemsContainer.resume({refresh:refresh}),this.latestItemsContainer.resume({refresh:refresh})];return Promise.all(promises)},function(instance,element,apiClient,parentId){var options={SortBy:"Random",IncludeItemTypes:"Series",Limit:20,Recursive:!0,ParentId:parentId,EnableImageTypes:"Backdrop",ImageTypes:"Backdrop",Fields:"Taglines",ImageTypeLimit:1};apiClient.getItems(apiClient.getCurrentUserId(),options).then(function(result){var card=element.querySelector(".wideSpotlightCard");instance.spotlight=new spotlight(card,result.Items,767)})}(self,element,apiClient,parentId),function(element,apiClient,parentId){apiClient.getItems(apiClient.getCurrentUserId(),{SortBy:"IsFavoriteOrLiked,Random",SortOrder:"Descending",IncludeItemTypes:"Series",Limit:3,Recursive:!0,ParentId:parentId,EnableImageTypes:"Backdrop",ImageTypes:"Backdrop",Fields:"PrimaryImageAspectRatio,ProductionYear,CommunityRating",ImageTypeLimit:1}).then(function(result){var items=result.Items,imgOptions={maxWidth:600};0<items.length&&(element.querySelector(".tvFavoritesCard .cardImage").style.backgroundImage="url('"+backdropImageUrl(items[0],imgOptions)+"')"),1<items.length&&(element.querySelector(".allSeriesCard .cardImage").style.backgroundImage="url('"+backdropImageUrl(items[1],imgOptions)+"')")})}(element,apiClient,parentId);var serverId=apiClient.serverId();element.querySelector(".allSeriesCard").addEventListener("click",function(){Emby.Page.show("/tv?parentId="+parentId+"&serverId="+serverId)}),element.querySelector(".tvUpcomingCard").addEventListener("click",function(){Emby.Page.show("/tv?tab=2&parentId="+parentId+"&serverId="+serverId)}),element.querySelector(".tvFavoritesCard").addEventListener("click",function(){Emby.Page.show("/tv?tab=3&parentId="+parentId+"&serverId="+serverId)}),self.onPause=function(){self.latestItemsContainer.pause(),self.resumeItemsContainer.pause(),self.nextUpItemsContainer.pause()},self.destroy=function(){self.spotlight&&(self.spotlight.destroy(),self.spotlight=null),self.latestItemsContainer=null,self.resumeItemsContainer=null,self.nextUpItemsContainer=null,self.apiClient=null}}});