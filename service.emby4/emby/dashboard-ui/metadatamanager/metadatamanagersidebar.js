define(["datetime","dom","jQuery","globalize","cardBuilder","material-icons","css!./metadatamanager"],function(datetime,dom,$,globalize,cardBuilder){"use strict";var selectedNodeId,itemId,nodesToLoad=[];function getNode(item,folderState,selected){var htmlName=getNodeInnerHtml(item),node={id:"livetv"===item.CollectionType?"livetv":item.Id,text:htmlName,state:{opened:item.IsFolder&&"open"===folderState,selected:selected},li_attr:{serveritemtype:item.Type,collectiontype:item.CollectionType}};return item.IsFolder&&(node.children=[{text:"Loading...",icon:!1}]),node.icon=!1,node.state.opened&&(node.li_attr.loadedFromServer=!0),selected&&(selectedNodeId=item.Id),node}function getNodeInnerHtml(item){var name=item.Name;item.Number&&(name=item.Number+" - "+name),null!=item.IndexNumber&&"Season"!==item.Type&&(name=item.IndexNumber+" - "+name);var htmlName="<div class='editorNode'>",icon=cardBuilder.getDefaultIcon(item);return item.IsFolder?htmlName+='<i class="md-icon editorSidebarIcon">folder</i>':icon&&(htmlName+='<i class="md-icon editorSidebarIcon">'+icon+"</i>"),item.LockData&&(htmlName+='<i class="md-icon editorSidebarIcon">lock</i>'),htmlName+=name,htmlName+="</div>"}function loadNode(page,scope,node,openItems,selectedId,currentUser,callback){var id=node.id;if("#"!==id)if("livetv"!==id){var query={ParentId:id,Fields:"Settings",IsVirtualUnaired:!1,IsMissing:!1,EnableTotalRecordCount:!1,EnableImages:!1,EnableUserData:!1},itemtype=node.li_attr.itemtype;"Season"===itemtype||"Series"===itemtype||ApiClient.isMinServerVersion("4.4.0.23")||(query.SortBy="SortName"),ApiClient.getItems(ApiClient.getCurrentUserId(),query).then(function(result){var nodes=result.Items.map(function(n){return getNode(n,-1===openItems.indexOf(n.Id)?"closed":"open",n.Id===selectedId)});callback.call(scope,nodes);for(var i=0,length=nodes.length;i<length;i++)nodes[i].state.opened&&nodesToLoad.push(nodes[i].id)})}else!function(openItems,callback){ApiClient.getLiveTvChannels({AddCurrentProgram:!1}).then(function(result){var nodes=result.Items.map(function(i){return getNode(i,-1===openItems.indexOf(i.Id)?"closed":"open",!1)});callback(nodes)})}(openItems,callback);else!function(page,scope,callback){ApiClient.getUserViews({},ApiClient.getCurrentUserId()).then(function(mediaFoldersResult){var nodes=mediaFoldersResult.Items.map(function(n){return getNode(n,"closed",!1)});callback.call(scope,nodes)})}(0,scope,callback)}function initializeTree(page,currentUser,openItems,selectedId){require(["jstree"],function(){!function(page,currentUser,openItems,selectedId){nodesToLoad=[],selectedNodeId=null,$.jstree.destroy(),$(page.querySelector(".libraryTree")).jstree({plugins:["wholerow"],core:{check_callback:!0,data:function(node,callback){loadNode(0,this,node,openItems,selectedId,0,callback)},themes:{variant:"large"}}}).off("select_node.jstree",onNodeSelect).on("select_node.jstree",onNodeSelect).off("open_node.jstree",onNodeOpen).on("open_node.jstree",onNodeOpen).off("load_node.jstree",onNodeLoad).on("load_node.jstree",onNodeLoad)}(page,0,openItems,selectedId)})}function onNodeSelect(event,data){var node=data.node,eventData={id:node.id,itemType:node.li_attr.itemtype,serverItemType:node.li_attr.serveritemtype,collectionType:node.li_attr.collectiontype};if("livetv"!==eventData.itemType&&"UserView"!==eventData.serverItemType&&"CollectionFolder"!==eventData.serverItemType&&!eventData.collectionType)return this.dispatchEvent(new CustomEvent("itemclicked",{detail:eventData,bubbles:!0,cancelable:!1})),void document.querySelector(".editPageSidebar").classList.add("editPageSidebar-withcontent");window.MetadataEditor&&window.MetadataEditor.setCurrentItemId(null),document.querySelector(".editPageSidebar").classList.remove("editPageSidebar-withcontent")}function onNodeOpen(event,data){var page=dom.parentWithClass(this,"page"),node=data.node;node.children&&node.children&&loadNodesToLoad(page,node),node.li_attr&&"#"!==node.id&&!node.li_attr.loadedFromServer&&(node.li_attr.loadedFromServer=!0,$.jstree.reference(".libraryTree",page).load_node(node.id,loadNodeCallback))}function onNodeLoad(event,data){var page=dom.parentWithClass(this,"page"),node=data.node;node.children&&node.children&&loadNodesToLoad(page,node),node.li_attr&&"#"!==node.id&&!node.li_attr.loadedFromServer&&(node.li_attr.loadedFromServer=!0,$.jstree.reference(".libraryTree",page).load_node(node.id,loadNodeCallback))}function getFilterFn(child){return function(n){return n!==child}}function loadNodesToLoad(page,node){for(var children=node.children,i=0,length=children.length;i<length;i++){var child=children[i];-1!==nodesToLoad.indexOf(child)&&(nodesToLoad=nodesToLoad.filter(getFilterFn(child)),$.jstree.reference(".libraryTree",page).load_node(child,loadNodeCallback))}}function loadNodeCallback(node){selectedNodeId&&node.children&&-1!==node.children.indexOf(selectedNodeId)&&setTimeout(function(){!function(id){var elem=document.getElementById(id);elem&&elem.scrollIntoView()}(selectedNodeId)},500)}function getParameterByName(name,url){name=name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var results=new RegExp("[\\?&]"+name+"=([^&#]*)","i").exec(url||function(win){var search=(win||window).location.search;if(!search){var index=window.location.href.indexOf("?");-1!==index&&(search=window.location.href.substring(index))}return search||""}());return null==results?"":decodeURIComponent(results[1].replace(/\+/g," "))}function getCurrentItemId(){return itemId||getParameterByName("id",window.location.hash||window.location.href)}$(document).on("itemsaved",".metadataEditorPage",function(e,item){!function(page,item){var elem=page.querySelector("#"+item.Id+">a");if(null!=elem){var editorNode=elem.querySelector(".editorNode");if(editorNode&&editorNode.parentNode.removeChild(editorNode),elem.insertAdjacentHTML("beforeend",getNodeInnerHtml(item)),item.IsFolder){var tree=$.jstree._reference(".libraryTree"),currentNode=tree._get_node(null,!1);tree.refresh(currentNode)}}}(this,item)}).on("viewbeforeshow",".metadataEditorPage",function(){var page=this;ApiClient.getCurrentUser().then(function(user){var id=getCurrentItemId();id?ApiClient.getAncestorItems(id,user.Id).then(function(ancestors){var ids=ancestors.map(function(i){return i.Id});initializeTree(page,0,ids,id)}):initializeTree(page,0,[])})}).on("viewbeforehide",".metadataEditorPage",function(){$(".libraryTree",this).off("select_node.jstree",onNodeSelect).off("open_node.jstree",onNodeOpen).off("load_node.jstree",onNodeLoad)}),window.MetadataEditor={getItemPromise:function(){var currentItemId=getCurrentItemId();return currentItemId?ApiClient.getItem(ApiClient.getCurrentUserId(),currentItemId):ApiClient.getRootFolder(ApiClient.getCurrentUserId())},getCurrentItemId:getCurrentItemId,setCurrentItemId:function(id){itemId=id}}});