define(["apphost","dialogHelper","layoutManager","globalize","browser","dom","emby-button","css!./actionsheet","material-icons","listViewStyle","emby-scroller"],function(appHost,dialogHelper,layoutManager,globalize,browser,dom){"use strict";function getPosition(options,dlg){var windowSize=dom.getWindowSize(),windowHeight=windowSize.innerHeight,windowWidth=windowSize.innerWidth,pos=function(elems){var box,elem,results=[];if(!document)return results;for(var i=0,length=elems.length;i<length;i++)box=(elem=elems[i]).getBoundingClientRect?elem.getBoundingClientRect():{top:0,left:0},results[i]={top:box.top,left:box.left,width:box.width,height:box.height};return results}([options.positionTo])[0];"top"!==options.positionY&&(pos.top+=(pos.height||0)/2),pos.left+=(pos.width||0)/2;var height=dlg.offsetHeight||300,width=dlg.offsetWidth||160;pos.top-=height/2,pos.left-=width/2;var overflowX=pos.left+width-windowWidth,overflowY=pos.top+height-windowHeight;return 0<overflowX&&(pos.left-=20+overflowX),0<overflowY&&(pos.top-=20+overflowY),pos.top+=options.offsetTop||0,pos.left+=options.offsetLeft||0,pos.top=Math.max(pos.top,10),pos.left=Math.max(pos.left,10),pos}var hasPhysicalBackButton=appHost.supports("physicalbackbutton");return{show:function(options){var dialogOptions={removeOnClose:!0,enableHistory:options.enableHistory,autoFocus:!0,autoCenter:!1};layoutManager.tv?(dialogOptions.size="fullscreen",dialogOptions.autoFocus=!0):dialogOptions.modal=!1;var type=options.type;layoutManager.tv&&(type=null);var dlg=dialogHelper.createDialog(dialogOptions);dlg.classList.add("actionSheet"),type&&dlg.classList.add("actionSheet-"+type),options.dialogClass&&dlg.classList.add(options.dialogClass);var i,length,option,itemIcon,html="",renderIcon=!1,icons=[];for(i=0,length=options.items.length;i<length;i++)(itemIcon=(option=options.items[i]).icon||(option.selected?"&#xe5ca;":null))&&(renderIcon=!0),icons.push(itemIcon||"");layoutManager.tv&&(html+='<button is="paper-icon-button-light" class="btnCloseActionSheet btnCloseActionSheet-tv hide-mouse-idle-tv" tabindex="-1"><i class="md-icon">&#xE5C4;</i></button>');var center=options.title&&!renderIcon;if((center||layoutManager.tv)&&dlg.classList.add("actionsheet-centered"),options.title){var headerClass="actionSheetTitle";"select"===type&&(headerClass+=" actionSheetTitle-select"),html+='<h2 class="'+headerClass+'">',html+=options.title,html+="</h2>"}options.text&&(html+='<p class="actionSheetText">',html+=options.text,html+="</p>");var scrollerClassName="actionSheetScroller";layoutManager.tv&&(scrollerClassName+=" actionSheetScroller-tv focuscontainer-x focuscontainer-y"),type&&(scrollerClassName+=" actionSheetScroller-"+type),(options.title||options.text)&&(scrollerClassName+=" actionSheetScroller-withheader"),html+='<div is="emby-scroller" data-horizontal="false" data-centerfocus="card" class="'+scrollerClassName+'">',html+='<div class="scrollSlider flex flex-direction-column">';var menuItemClass="listItem listItem-button actionSheetMenuItem";(options.border||options.shaded)&&(menuItemClass+=" listItem-border"),options.menuItemClass&&(menuItemClass+=" "+options.menuItemClass),layoutManager.tv&&(menuItemClass+=" listItem-focusscale"),type&&(menuItemClass+=" actionSheetMenuItem-"+type),layoutManager.tv&&(menuItemClass+=" actionSheetMenuItem-tv");var asideTextClass="actionSheetItemAsideText";type&&(asideTextClass+=" actionSheetItemAsideText-"+type);var listItemBodyClass="actionsheetListItemBody";type&&(listItemBodyClass+=" actionsheetListItemBody-"+type);var selectedId,timeout,itemIconClass="actionsheetMenuItemIcon listItemIcon listItemIcon-transparent md-icon secondaryText";for(type&&(itemIconClass+=" actionsheetMenuItemIcon-"+type),i=0,length=options.items.length;i<length;i++)if((option=options.items[i]).divider)html+='<div class="actionsheetDivider"></div>';else{var autoFocus=option.selected?" autoFocus":"",currentMenuItemClass=menuItemClass;option.selected&&(currentMenuItemClass+=" actionSheetMenuItem-selected"),option.hideWithFinePointer&&(currentMenuItemClass+=" actionSheetMenuItem-hiddenfinepointer"),html+="<button"+autoFocus+' is="emby-button" type="button" class="'+currentMenuItemClass+'" data-id="'+(null==option.id||""===option.id?option.value:option.id)+'">',(itemIcon=icons[i])?html+='<i class="'+itemIconClass+'">'+itemIcon+"</i>":renderIcon&&!center&&(html+='<i class="'+itemIconClass+'" style="visibility:hidden;">&#xe5ca;</i>'),html+='<div class="listItemBody '+listItemBodyClass+'">',html+='<div class="listItemBodyText actionSheetItemText">',html+=option.name||option.textContent||option.innerText,html+="</div>",option.secondaryText&&(html+='<div class="listItemBodyText listItemBodyText-secondary">',html+=option.secondaryText,html+="</div>"),html+="</div>",option.asideText&&(html+='<div class="listItemAside '+asideTextClass+'">',html+=option.asideText,html+="</div>"),option.asideIcon&&(html+='<div class="listItemAside '+asideTextClass+'"><i class="md-icon">',html+=option.asideIcon,html+="</i></div>"),html+="</button>"}if(html+="</div>",html+="</div>",options.bottomText&&(html+='<div class="actionSheetBottomText fieldDescription">',html+=options.bottomText,html+="</div>"),!(layoutManager.tv||"select"!==type&&hasPhysicalBackButton)){html+="select"===type?'<div class="actionSheet-bottom actionSheet-select-bottom">':'<div class="actionSheet-bottom">';var cancelButtonClass="btnCloseActionSheet btnCloseActionSheet-default";"select"===type&&(cancelButtonClass+=" btnCloseActionSheet-select"),html+='<button is="emby-button" type="button" class="'+cancelButtonClass+' hide-mouse-idle-tv raised block">'+globalize.translate("Cancel")+"</button>",html+="</div>"}return dlg.innerHTML=html,dlg.querySelector(".btnCloseActionSheet")&&dlg.querySelector(".btnCloseActionSheet").addEventListener("click",function(){dialogHelper.close(dlg)}),options.timeout&&(timeout=setTimeout(function(){dialogHelper.close(dlg)},options.timeout)),new Promise(function(resolve,reject){var isResolved;dlg.addEventListener("click",function(e){var actionSheetMenuItem=dom.parentWithClass(e.target,"actionSheetMenuItem");actionSheetMenuItem&&(selectedId=actionSheetMenuItem.getAttribute("data-id"),options.resolveOnClick&&(options.resolveOnClick.indexOf?-1!==options.resolveOnClick.indexOf(selectedId)&&(resolve(selectedId),isResolved=!0):(resolve(selectedId),isResolved=!0)),dialogHelper.close(dlg))}),dlg.addEventListener("close",function(){timeout&&(clearTimeout(timeout),timeout=null),isResolved||(null!=selectedId?(options.callback&&options.callback(selectedId),resolve(selectedId)):reject())}),dialogHelper.open(dlg);var pos=options.positionTo&&"fullscreen"!==dialogOptions.size?getPosition(options,dlg):null;pos&&(dlg.style.position="fixed",dlg.style.left=pos.left+"px",dlg.style.top=pos.top+"px")})}}});