define(["appRouter","focusManager","browser","inputManager","dom","Modernizr","css!./dialoghelper.css","scrollStyles"],function(appRouter,focusManager,browser,inputManager,dom,Modernizr){"use strict";var globalOnOpenCallback;function enableAnimation(){return Modernizr.cssanimations&&dom.supportsEventListenerOnce()}function tryRemoveElement(elem){var parentNode=elem.parentNode;if(parentNode)try{parentNode.removeChild(elem)}catch(err){console.log("Error removing dialog element: "+err)}}function getScrollingElement(){return document.scrollingElement||document.documentElement}function DialogHashHandler(dlg,hash,resolve){var self=this;self.originalUrl=window.location.href;var activeElement=document.activeElement,removeScrollLockOnClose=!1;function onHashChange(e){var isBack=self.originalUrl===window.location.href;!isBack&&isOpened(dlg)||window.removeEventListener("popstate",onHashChange),isBack&&closeDialog(dlg)}function onInputCommand(e){var command=e.detail.command;"back"===command?isHistoryEnabled(dlg)||(e.preventDefault(),e.stopPropagation(),closeDialog(dlg)):"home"!==command&&"end"!==command&&"settings"!==command&&"guide"!==command&&"recordedtv"!==command&&"favorites"!==command&&"channelup"!==command&&"channeldown"!==command||e.preventDefault()}dlg.addEventListener("close",function(){if(inputManager.off(dlg,onInputCommand),window.removeEventListener("popstate",onHashChange),function(dlg){var backdrop=dlg.backdrop;if(!backdrop)return;dlg.backdrop=null;function onAnimationFinish(){tryRemoveElement(backdrop)}if(enableAnimation())return backdrop.classList.remove("dialogBackdropOpened"),setTimeout(onAnimationFinish,300);onAnimationFinish()}(dlg),dlg.classList.remove("opened"),removeScrollLockOnClose&&getScrollingElement().classList.remove("withDialogOpen"),activeElement&&focusManager.focus(activeElement),"false"!==dlg.getAttribute("data-removeonclose")){var dialogContainer=dlg.dialogContainer;dialogContainer?(tryRemoveElement(dialogContainer),dlg.dialogContainer=null):tryRemoveElement(dlg)}setTimeout(function(){resolve({element:dlg})},1)}),function(dlg){var backdrop=document.createElement("div");backdrop.classList.add("dialogBackdrop");var backdropParent=dlg.dialogContainer||dlg;backdropParent.parentNode.insertBefore(backdrop,backdropParent),(dlg.backdrop=backdrop).offsetWidth,backdrop.classList.add("dialogBackdropOpened"),dom.addEventListener(dlg.dialogContainer||backdrop,"click",function(e){e.target===dlg.dialogContainer&&close(dlg)},{passive:!0})}(dlg),dlg.classList.remove("hide"),dlg.classList.add("opened"),dlg.dispatchEvent(new CustomEvent("open",{bubbles:!1,cancelable:!1}));var scrollingElement=getScrollingElement();"true"!==dlg.getAttribute("data-lockscroll")||scrollingElement.classList.contains("withDialogOpen")||(scrollingElement.classList.add("withDialogOpen"),removeScrollLockOnClose=!0),function(dlg){if(enableAnimation())return dom.addEventListener(dlg,"animationend",onOpenAnimationFinish,{passive:!0});onOpenAnimationFinish.call(dlg,{target:dlg,currentTarget:dlg})}(dlg),isHistoryEnabled(dlg)&&(appRouter.pushState({dialogId:hash},"Dialog","#"+hash),window.addEventListener("popstate",onHashChange)),inputManager.on(dlg,onInputCommand)}function onOpenAnimationFinish(e){if(e.target===e.currentTarget){dom.removeEventListener(this,"animationend",onOpenAnimationFinish,{passive:!0}),focusManager.pushScope(this),this.dispatchEvent(new CustomEvent("opened",{bubbles:!1,cancelable:!1})),"true"===this.getAttribute("data-autofocus")&&focusManager.autoFocus(this)}}function isHistoryEnabled(dlg){return"true"===dlg.getAttribute("data-history")}function isOpened(dlg){return!dlg.classList.contains("hide")}function close(dlg){isOpened(dlg)&&(isHistoryEnabled(dlg)?appRouter.back():closeDialog(dlg))}function onCloseAnimationFinish(e){if(e.target===e.currentTarget){dom.removeEventListener(this,"animationend",onCloseAnimationFinish,{passive:!0}),focusManager.popScope(this),this.classList.add("hide"),this.dispatchEvent(new CustomEvent("close",{bubbles:!1,cancelable:!1}))}}function closeDialog(dlg){dlg.classList.contains("hide")||(dlg.dispatchEvent(new CustomEvent("closing",{bubbles:!1,cancelable:!1})),dlg.classList.add("dialog-close"),enableAnimation()?dom.addEventListener(dlg,"animationend",onCloseAnimationFinish,{once:!0}):onCloseAnimationFinish.call(dlg,{target:dlg,currentTarget:dlg}))}return{open:function(dlg){globalOnOpenCallback&&globalOnOpenCallback(dlg);var parent=dlg.parentNode;parent&&parent.removeChild(dlg);var dialogContainer=document.createElement("div");return dialogContainer.classList.add("dialogContainer"),dialogContainer.appendChild(dlg),dlg.dialogContainer=dialogContainer,document.body.appendChild(dialogContainer),new Promise(function(resolve,reject){new DialogHashHandler(dlg,"dlg"+Date.now(),resolve)})},close:close,createDialog:function(options){options=options||{};var dlg=document.createElement("div");return dlg.classList.add("focuscontainer"),dlg.classList.add("hide"),dlg.setAttribute("data-lockscroll","true"),!1!==options.enableHistory&&appRouter.enableNativeHistory()&&dlg.setAttribute("data-history","true"),!1!==options.modal&&dlg.setAttribute("modal","modal"),!1!==options.autoFocus&&dlg.setAttribute("data-autofocus","true"),dlg.classList.add("dialog"),enableAnimation()||dlg.classList.add("dialog-noanimation"),options.removeOnClose&&dlg.setAttribute("data-removeonclose","true"),options.size&&(dlg.classList.add("dialog-fixedSize"),dlg.classList.add("dialog-"+options.size)),!1===options.autoCenter||dlg.classList.contains("dialog-fixedSize")||dlg.classList.add("centeredDialog"),dlg},setOnOpen:function(val){globalOnOpenCallback=val}}});