define(["require","inputManager","browser","globalize","connectionManager","scrollHelper","serverNotifications","loading","datetime","focusManager","playbackManager","userSettings","imageLoader","events","layoutManager","itemShortcuts","dom","./gridrowrenderer","css!./guide.css","programStyles","material-icons","scrollStyles","emby-button","paper-icon-button-light","emby-tabs","emby-scroller","flexStyles"],function(require,inputManager,browser,globalize,connectionManager,scrollHelper,serverNotifications,loading,datetime,focusManager,playbackManager,userSettings,imageLoader,events,layoutManager,itemShortcuts,dom,gridRowRenderer){"use strict";var cellCurationMinutes=30,cellDurationMs=60*cellCurationMinutes*1e3,msPerPage=288e5,startId=Date.now();function onSettingsButtonClick(){var instance=this;require(["guide-settings-dialog"],function(guideSettingsDialog){guideSettingsDialog.show(instance.categoryOptions).then(function(){instance.refresh()})})}function onDateButtonClick(e){var instance=this;require(["actionsheet"],function(actionsheet){var options=function(instance){var items=[],start=new Date(instance._startDateMs),end=new Date(instance._endDateMs),today=new Date,nowHours=today.getHours(),nowMinutes=30<=today.getMinutes()?30:0;start.setHours(nowHours,nowMinutes,0,0),end.setHours(0,0,0,0),start.getTime()>=end.getTime()&&end.setDate(start.getDate()+1),start=new Date(Math.max(today,start));var scroller=instance.scroller,scrollWidth=getScrollerScrollWidth(instance);scrollWidth-=getChannelCellWidth(instance);for(var startDate=instance._startDateMs,endDate=instance._endDateMs,currentPositionMs=scroller.scrollLeft/scrollWidth*(endDate-startDate),date=new Date(currentPositionMs+=startDate);start<=end;)items.push({name:datetime.toLocaleDateString(start,{weekday:"long",month:"short",day:"numeric"}),value:start.getTime().toString(),selected:date.getDate()===start.getDate()&&date.getMonth()===start.getMonth()&&date.getFullYear()===start.getFullYear()}),start.setDate(start.getDate()+1),start.setHours(0,0,0,0);return items}(instance);actionsheet.show({items:options,positionTo:e.target,title:globalize.translate("HeaderSelectDate")}).then(function(value){var date=new Date;date.setTime(parseInt(value));var scroller=this.scroller,scrollWidth=getScrollerScrollWidth(this);if(!scrollWidth)return;var channelCellWidth=getChannelCellWidth(this);scrollWidth-=channelCellWidth;var startDate=this._startDateMs,endDate=this._endDateMs,currentPositionMs=scroller.scrollLeft/scrollWidth*(endDate-startDate),currentPositionDate=new Date(currentPositionMs+=startDate);date.setHours(currentPositionDate.getHours(),currentPositionDate.getMinutes(),0,0);var pct=(date.getTime()-startDate)/(endDate-startDate);(function(container,pos,horizontal){container.scroll?horizontal?container.scroll({left:pos}):container.scroll({top:pos}):horizontal?container.scrollLeft=Math.round(pos):container.scrollTop=Math.round(pos)})(scroller,pct*scrollWidth,!0),onScroll.call(this,{currentTarget:this.scroller,target:this.scroller})}.bind(instance))})}function updateProgramCellOnScroll(cell,scrollPct,hidden){var pctOfWidth;if(!hidden){var left=cell.posLeft;left||(left=parseFloat(cell.style.left.replace("%","")),cell.posLeft=left);var width=cell.posWidth;width||(width=parseFloat(cell.style.width.replace("%","")),cell.posWidth=width);var right=left+width;99.8<=(pctOfWidth=(Math.max(Math.min(scrollPct,right),left)-left)/width*100)&&(pctOfWidth=0)}var guideProgramName=cell.guideProgramName;!guideProgramName&&pctOfWidth&&(guideProgramName=cell.querySelector(".guideProgramName"),cell.guideProgramName=guideProgramName);var caret=cell.caret;if(!caret&&pctOfWidth&&(caret=cell.querySelector(".guide-programNameCaret"),cell.caret=caret),guideProgramName){if(pctOfWidth)return guideProgramName.style.marginLeft=pctOfWidth+"%",caret&&caret.classList.remove("hide"),!0;guideProgramName.style.marginLeft="0",caret&&caret.classList.add("hide")}return!1}function getChannelCellWidth(instance){var channelCellWidth=instance.channelCellWidth;return channelCellWidth||(channelCellWidth=instance.options.element.querySelector(".firstChannelCell").offsetWidth,instance.channelCellWidth=channelCellWidth),channelCellWidth}function getScrollerScrollWidth(instance){var scrollerScrollWidth=instance.scrollerScrollWidth;return scrollerScrollWidth||(scrollerScrollWidth=instance.scroller.scrollWidth,instance.scrollerScrollWidth=scrollerScrollWidth),scrollerScrollWidth}function getTimeBlockStart(instance,scrollLeft,scrollWidth){var startDate=instance._startDateMs,endDate=instance._endDateMs,currentPositionMs=scrollWidth?scrollLeft/scrollWidth*(endDate-startDate):0;return currentPositionMs=Math.floor(currentPositionMs),currentPositionMs-=currentPositionMs%msPerPage,currentPositionMs+=startDate}function getProgramFieldsProperty(){var programFields=[];return"true"===userSettings.get("guide-indicator-hd")&&(programFields.push("IsHD"),programFields.push("Width")),programFields.length?programFields.join(","):null}function loadPrograms(instance,epgRowMap,channelIds,timeBlockStart){var promise,apiClient=connectionManager.getApiClient(instance.options.serverId),cacheKey=[apiClient.getCurrentUserId(),timeBlockStart.toString(),channelIds.join(",")].join("|");instance.programCache||(instance.programCache={});var cachedResult=instance.programCache[cacheKey];if(cachedResult&&(promise=Promise.resolve(cachedResult)),!promise){var offset=timeBlockStart===getTimeBlockStart(instance,0,0)?1e3:0,programQuery={UserId:apiClient.getCurrentUserId(),MaxStartDate:new Date(timeBlockStart+msPerPage).toISOString(),MinEndDate:new Date(timeBlockStart+offset).toISOString(),channelIds:channelIds.join(","),ImageTypeLimit:1,EnableImages:!1,SortBy:"StartDate",EnableTotalRecordCount:!1,EnableUserData:!1,Fields:getProgramFieldsProperty()};promise=apiClient.getLiveTvPrograms(programQuery)}return promise.then(function(result){return instance.programCache[cacheKey]=result,function(instance,epgRowMap,programs){for(var i=0,length=programs.length;i<length;i++){var program=programs[i],epgItem=epgRowMap[program.ChannelId];epgItem&&addProgramToList(instance,epgItem,program)}updateCellTexts(instance)}(instance,epgRowMap,result.Items)})}function getInsertIndex(programs,programStartTime){for(var numPrograms=programs.length,insertAtIndex=numPrograms,i=0,length=numPrograms;i<length;i++)if(programStartTime<=programs[i].StartDateLocalMs){insertAtIndex=i;break}return insertAtIndex}function addProgramToList(instance,epgItem,program){gridRowRenderer.parseDates(program);var insertAtIndex,programs=epgItem.Programs,programMap=epgItem.ProgramMap,programId=program.Id;programMap[programId]||(insertAtIndex=getInsertIndex(programs,(programMap[programId]=program).StartDateLocalMs),programs.splice(insertAtIndex,0,program));var channelRow=epgItem.RowElement;if(channelRow){var channelProgramsElement=channelRow.children[1];if(channelProgramsElement&&(programMap=channelRow.ProgramMap)&&!programMap[programId]){programMap[programId]=program,insertAtIndex=getInsertIndex(programs=channelRow.Programs,program.StartDateLocalMs),programs.splice(insertAtIndex,0,program);var options=instance.programRenderOptions,totalGridMs=options.endMs-options.startMs,html=gridRowRenderer.getProgramHtml(program,options,totalGridMs),insertBeforeChild=channelProgramsElement.children[insertAtIndex];insertBeforeChild?insertBeforeChild.insertAdjacentHTML("beforebegin",html):channelProgramsElement.insertAdjacentHTML("beforeend",html)}}}function onScroll(e){var scrollLeft=(e.currentTarget||e.target).scrollLeft,scrollXChanged=this.lastScrollLeft!==scrollLeft;if(scrollXChanged||e.forceHorizontalChange){var timeslotsContainer=this.timeslotsContainer;timeslotsContainer&&(timeslotsContainer.scrollLeft=scrollLeft);var channelCellWidth=getChannelCellWidth(this),scrollWidth=getScrollerScrollWidth(this)-channelCellWidth,scrollPct=scrollLeft?scrollLeft/scrollWidth*100:0;this.lastHorizontalScrollPct=scrollPct,this.startDataLoadTimer(scrollLeft),this.lastScrollLeft=scrollLeft,updateCellTexts(this,scrollPct,e.updateProgramTextRow),scrollXChanged&&this.updateDateButtonText(scrollLeft,scrollWidth)}}function updateCellTexts(instance,scrollPct,rowToUpdate){if(null==scrollPct){var scrollLeft=instance.scroller.scrollLeft,channelCellWidth=getChannelCellWidth(instance),scrollWidth=getScrollerScrollWidth(instance)-channelCellWidth;scrollPct=scrollLeft?scrollLeft/scrollWidth*100:0}if(rowToUpdate)updateProgramCellTextsForRow(rowToUpdate,scrollPct);else for(var activeItemElements=instance.itemsContainer.virtualScroller.getActiveItems().elements,i=0,length=activeItemElements.length;i<length;i++)updateProgramCellTextsForRow(activeItemElements[i],scrollPct)}function updateProgramCellTextsForRow(row,scrollPct){var channelPrograms=row.children[1];if(channelPrograms)for(var programCells=channelPrograms.children,caretFound=!1,i=0,length=programCells.length;i<length;i++)updateProgramCellOnScroll(programCells[i],scrollPct,caretFound)&&(caretFound=!0)}function onFocusInScroller(e){if(layoutManager.tv){var target=e.target,focused=focusManager.focusableParent(target);if(focused)!function(instance,container,elem){var customXOffset=0-getChannelCellWidth(instance),posX=scrollHelper.getPosition(container,elem,!0,customXOffset),posY=scrollHelper.getPosition(container,elem,!1,0);posX.isVisible&&posY.isVisible||(container.scroll?container.scroll({left:posX.start,top:posY.center}):(container.scrollLeft=Math.round(posX.start),container.scrollTop=Math.round(posY.center)))}(this,e.currentTarget,focused);var programCell=dom.parentWithClass(target,"programCell");if(programCell){var row=dom.parentWithClass(programCell,"epgRow"),programs=itemShortcuts.getItemFromChildNode(row).Programs,id=programCell.getAttribute("data-id"),item=programs.filter(function(p){return p.Id===id})[0];item&&events.trigger(this,"focus",[{item:item}])}}}function initialRender(instance){return instance.rendered?Promise.resolve():(instance.rendered=!0,require(["text!./tvguide.template.html"]).then(function(responses){var context=instance.options.element;if(context.classList.add("tvguide"),context.innerHTML=globalize.translateDocument(responses[0],"sharedcomponents"),layoutManager.tv?(context.querySelector(".btnGuideViewSettings-side").classList.remove("hide"),context.querySelector(".btnSelectDate-side").classList.remove("hide")):context.querySelector(".itemsViewSettingsContainer").classList.remove("hide"),layoutManager.tv&&context.querySelector(".firstChannelCell").classList.add("channelCell-condensed"),itemShortcuts.on(context),instance.onTimerCreatedFn=function(e,apiClient,data){for(var programId=data.ProgramId,newTimerId=data.Id,cells=this.options.element.querySelectorAll('.programCell[data-id="'+programId+'"]'),i=0,length=cells.length;i<length;i++){var cell=cells[i];cell.querySelector(".timerIcon")||cell.querySelector(".guideProgramName").insertAdjacentHTML("beforeend",'<i class="timerIcon md-icon programIcon">&#xE061;</i>'),newTimerId&&cell.setAttribute("data-timerid",newTimerId)}}.bind(instance),events.on(serverNotifications,"TimerCreated",instance.onTimerCreatedFn),instance.onSeriesTimerCreatedFn=function(e,apiClient,data){}.bind(instance),events.on(serverNotifications,"SeriesTimerCreated",instance.onSeriesTimerCreatedFn),instance.onTimerCancelledFn=function(e,apiClient,data){for(var options=this.options,id=data.Id,cells=options.element.querySelectorAll('.programCell[data-timerid="'+id+'"]'),i=0,length=cells.length;i<length;i++){var cell=cells[i],icon=cell.querySelector(".timerIcon");icon&&icon.parentNode.removeChild(icon),cell.removeAttribute("data-timerid")}}.bind(instance),events.on(serverNotifications,"TimerCancelled",instance.onTimerCancelledFn),instance.onSeriesTimerCancelledFn=function(e,apiClient,data){for(var options=this.options,id=data.Id,cells=options.element.querySelectorAll('.programCell[data-seriestimerid="'+id+'"]'),i=0,length=cells.length;i<length;i++){var cell=cells[i],icon=cell.querySelector(".seriesTimerIcon");icon&&icon.parentNode.removeChild(icon),cell.removeAttribute("data-seriestimerid")}}.bind(instance),events.on(serverNotifications,"SeriesTimerCancelled",instance.onSeriesTimerCancelledFn),instance.scroller=instance.options.element.querySelector(".virtualScrollerScrollContainer"),instance.uniqueId=startId,instance.scrollSliderUniqueClass="epgScrollSlider"+startId,instance.scrollDirectionHack){instance.scroller=instance.options.element.querySelector(".scrollSlider"),instance.scroller.classList.add("scrollX"),instance.options.element.querySelector(".epgScrollSlider").classList.remove("epgScrollSlider"),instance.options.element.querySelector(".epgScrollSlider-scrolldirectionhack").classList.add("epgScrollSlider");var timeslotsContainer=context.querySelector(".guide-headerTimeslots");timeslotsContainer.classList.add("scrollX"),timeslotsContainer.classList.add("hiddenScrollX"),(instance.timeslotsContainer=timeslotsContainer).querySelector(".timeslotsScrollContent").classList.add(instance.scrollSliderUniqueClass)}else instance.scroller.classList.add("epgVirtualScrollerScrollContainer-both");dom.addEventListener(instance.scroller,"scroll",onScroll.bind(instance),{passive:!0});var i,length,itemsContainer=context.querySelector(".itemsContainer");itemsContainer.fetchData=instance.getItems.bind(instance),itemsContainer.afterRefresh=function(){var cssClass="guide-currentTimeIndicatorDot hide";layoutManager.tv&&(cssClass+=" guide-currentTimeIndicatorDot-condensed"),this.itemsContainer.virtualScroller.insertAdjacentHTML("afterbegin",'<div class="'+cssClass+'"></div>'),this.currentTimeIndicatorDot=this.options.element.querySelector(".guide-currentTimeIndicatorDot"),this.startCurrentTimeUpdateInterval()}.bind(instance),itemsContainer.virtualChunkSize=30,itemsContainer.getListOptions=instance.getListOptions.bind(instance),(instance.itemsContainer=itemsContainer).onUpdateElement=function(row,item,index){(item.RowElement=row).Programs=item.Programs.slice(0),row.ProgramMap=getProgramMap(row),this.itemsContainer.itemParts[index]=null,onScroll.call(this,{target:this.scroller,currentTarget:this.scroller,updateProgramTextRow:row,forceHorizontalChange:!0})}.bind(instance),itemsContainer.onRecycleElement=function(row,index){row.ProgramMap=null;var item=this.itemsContainer.getItem(index);item&&(item.RowElement=null)}.bind(instance),instance.channelCellResizeObserver=new ResizeObserver(function(entries){var entry=entries[0];if(entry){entry.contentRect;this.channelCellWidth=null,this.scrollerOffsetWidth=null,this.scrollerScrollWidth=null}}.bind(instance),{}),instance.channelCellResizeObserver.observe(context.querySelector(".firstChannelCell"));var settingsButtons=context.querySelectorAll(".btnGuideViewSettings");for(i=0,length=settingsButtons.length;i<length;i++)settingsButtons[i].addEventListener("click",onSettingsButtonClick.bind(instance));var dateButtons=context.querySelectorAll(".btnSelectDate");for(i=0,length=dateButtons.length;i<length;i++)dateButtons[i].addEventListener("click",onDateButtonClick.bind(instance));layoutManager.tv&&dom.addEventListener(instance.scroller,"focus",onFocusInScroller.bind(instance),{capture:!0,passive:!0}),instance.styleElementUniqueClass="guideStyle"+startId,context.querySelector(".epgScrollSlider").classList.add(instance.scrollSliderUniqueClass),startId++}))}function Guide(options){this.options=options,this.categoryOptions={categories:[]},this.boundLoadPrograms=function(){for(var activeItems=this.itemsContainer.virtualScroller.getActiveItems(),elements=activeItems.elements,channelIdsNeedingData=[],epgRowMap={},numActiveRows=Math.min(elements.length,activeItems.lastIndex-activeItems.firstIndex+1),i=0;i<numActiveRows;i++){elements[i];var itemIndex=activeItems.firstIndex+i,item=this.itemsContainer.getItem(itemIndex);if(item){var channelId=item.Channel.Id;epgRowMap[channelId]=item,channelIdsNeedingData.push(channelId)}}if(channelIdsNeedingData.length){var timeBlockStart,scrollLeft=this._loadDataInfo,channelCellWidth=getChannelCellWidth(this),scrollWidth=getScrollerScrollWidth(this)-channelCellWidth,offsetWidth=function(instance){var scrollerOffsetWidth=instance.scrollerOffsetWidth;return scrollerOffsetWidth||(scrollerOffsetWidth=instance.options.element.offsetWidth,instance.scrollerOffsetWidth=scrollerOffsetWidth),scrollerOffsetWidth}(this),originalScrollLeft=scrollLeft,timeblocks=[];scrollLeft=originalScrollLeft,scrollLeft=Math.min(scrollLeft,scrollWidth),(scrollLeft=Math.max(scrollLeft,0))?scrollLeft/scrollWidth*100:0,timeBlockStart=getTimeBlockStart(this,scrollLeft,scrollWidth),-1===timeblocks.indexOf(timeBlockStart)&&(loadPrograms(this,epgRowMap,channelIdsNeedingData,timeBlockStart),timeblocks.push(timeBlockStart)),scrollLeft=originalScrollLeft,scrollLeft-=offsetWidth,scrollLeft=Math.min(scrollLeft,scrollWidth),(scrollLeft=Math.max(scrollLeft,0))?scrollLeft/scrollWidth*100:0,timeBlockStart=getTimeBlockStart(this,scrollLeft,scrollWidth),-1===timeblocks.indexOf(timeBlockStart)&&(loadPrograms(this,epgRowMap,channelIdsNeedingData,timeBlockStart),timeblocks.push(timeBlockStart)),scrollLeft=originalScrollLeft,scrollLeft+=offsetWidth,scrollLeft=Math.min(scrollLeft,scrollWidth),(scrollLeft=Math.max(scrollLeft,0))?scrollLeft/scrollWidth*100:0,timeBlockStart=getTimeBlockStart(this,scrollLeft,scrollWidth),-1===timeblocks.indexOf(timeBlockStart)&&(loadPrograms(this,epgRowMap,channelIdsNeedingData,timeBlockStart),timeblocks.push(timeBlockStart))}}.bind(this),this.lastScrollTop=0,this.lastScrollLeft=0}function normalizeDateToTimeslot(date){return 0<=date.getMinutes()-cellCurationMinutes?date.setHours(date.getHours(),cellCurationMinutes,0,0):date.setHours(date.getHours(),0,0,0),date}function getDisplayTime(date){if("string"===(typeof date).toString().toLowerCase())try{date=datetime.parseISO8601Date(date,{toLocal:!0})}catch(err){return date}return datetime.getDisplayTime(date)}function getWidth(numCells,widthPerCell,extra){return numCells*widthPerCell+extra}function renderWidthCss(instance){instance.scrollSliderUniqueClass;var numCells=Math.ceil((instance._endDateMs-instance._startDateMs)/cellDurationMs),html="\n.epgScrollSlider {\n        width: "+getWidth(numCells,37.5,7)+"vw;\n}\n\n@media all and (min-width: 37.5em) {\n\n    .epgScrollSlider {\n        width: "+getWidth(numCells,29.167,7)+"vw;\n    }\n}\n\n@media all and (min-width: 50em) {\n\n    .epgScrollSlider {\n        width: "+getWidth(numCells,25,8)+"vw;\n    }\n}\n\n@media all and (min-width: 80em) {\n\n    .epgScrollSlider {\n        width: "+getWidth(numCells,16.66667,10)+"vw;\n    }\n}\n    ";html=function(originalString,strReplace,strWith){var strReplace2=function(str){return str.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")}(strReplace),reg=new RegExp(strReplace2,"ig");return originalString.replace(reg,strWith)}(html,"epgScrollSlider",instance.scrollSliderUniqueClass);var elem=document.querySelector("."+instance.styleElementUniqueClass);elem?elem.innerHTML=html:((elem=document.createElement("style")).innerHTML=html,document.head.appendChild(elem))}function onGetGuideInfo(guideInfo){datetime.parseISO8601Date(guideInfo.StartDate,{toLocal:!0});var end=datetime.parseISO8601Date(guideInfo.EndDate,{toLocal:!0}),today=new Date,nowHours=today.getHours(),nowMinutes=30<=today.getMinutes()?30:0,date=new Date;date.setHours(nowHours,nowMinutes,0,0),loading.show();var startDate=this._startDateMs=normalizeDateToTimeslot(date).getTime(),endDate=this._endDateMs=normalizeDateToTimeslot(end).getTime(),instance=this;return renderWidthCss(instance),this.options.element.querySelector(".timeslotHeaders").innerHTML=function(originalStartDateMs,endDateTimeMs){for(var startDate=new Date(originalStartDateMs),numSlots=0;startDate.getTime()<endDateTimeMs;)numSlots++,startDate.setTime(startDate.getTime()+cellDurationMs);var width=100/numSlots;startDate=new Date(originalStartDateMs);for(var html="";startDate.getTime()<endDateTimeMs;)html+='<div class="timeslotHeader" style="width:'+width+'%;">',html+=getDisplayTime(startDate),html+="</div>",startDate.setTime(startDate.getTime()+cellDurationMs);return html}(startDate,endDate),this.updateDateButtonText(0),this.options.element.querySelector(".btnSelectDate").classList.remove("hide"),this.itemsContainer.resume({refresh:!0}).then(function(){setTimeout(function(){focusManager.autoFocus(instance.itemsContainer)},layoutManager.tv?500:100),loading.hide()})}var dateLocalOptions={weekday:"short",month:"short",day:"numeric"};function getProgramMap(epgItem){for(var programMap={},items=epgItem.Programs,i=0,length=items.length;i<length;i++){var item=items[i];programMap[item.Id]=item}return programMap}return Guide.prototype.updateDateButtonText=function(scrollLeft,scrollWidth){var startDate=this._startDateMs,endDate=this._endDateMs,currentPositionMs=scrollWidth?scrollLeft/scrollWidth*(endDate-startDate):0,date=new Date(currentPositionMs+=startDate);(this.btnDateText||(this.btnDateText=this.options.element.querySelector(layoutManager.tv?".btnDateText-side":".btnDateText-main"))).innerHTML=datetime.toLocaleDateString(date,dateLocalOptions)},Guide.prototype.stopCurrentTimeUpdateInterval=function(){var interval=this.currentTimeUpdateInterval;interval&&(clearInterval(interval),this.currentTimeUpdateInterval=null)},Guide.prototype.startCurrentTimeUpdateInterval=function(){var interval=this.currentTimeUpdateInterval,fn=function(){var pct,dot=this.currentTimeIndicatorDot,startDateMs=this._startDateMs,endDate=this._endDateMs,now=Date.now(),showIndicator=0<=(pct=startDateMs&&endDate?(now-startDateMs)/(endDate-startDateMs)*100:-100)&&pct<=100;pct=pct.toFixed(2)+"%",dot&&(dot.style.left=pct,dot.title=getDisplayTime(new Date(now)),showIndicator?dot.classList.remove("hide"):dot.classList.add("hide"))}.bind(this);interval||(this.currentTimeUpdateInterval=setInterval(fn,4e4)),setTimeout(fn,200)},Guide.prototype.pause=function(){this.stopCurrentTimeUpdateInterval()},Guide.prototype.resume=function(options){var instance=this;return browser.msie?(this.options.element.innerHTML='<div class="padded-left padded-right padded-top padded-bottom" style="text-align:center;">The Emby Live TV Guide is no longer supported in Internet Explorer. Please try a modern browser such as Microsoft Edge, Google Chrome, Firefox or Opera.</div>',Promise.resolve()):initialRender(instance).then(function(){if(options&&options.refresh)return instance.refresh();var itemsContainer=instance.itemsContainer;return itemsContainer?itemsContainer.resume(options):(instance.startCurrentTimeUpdateInterval(),Promise.resolve())})},Guide.prototype.refresh=function(){return this.cancelDataLoadTimer(),connectionManager.getApiClient(this.options.serverId).getLiveTvGuideInfo().then(onGetGuideInfo.bind(this))},Guide.prototype.getItems=function(query){var options=this.options,apiClient=connectionManager.getApiClient(options.serverId),endDate=this._startDateMs+msPerPage,maxEndDate=this._endDateMs-2e3;endDate=Math.min(endDate,maxEndDate);var epgQuery=Object.assign({EnableFavoriteSorting:"false"!==userSettings.get("livetv-favoritechannelsattop"),Fields:"PrimaryImageAspectRatio",Limit:30,MaxStartDate:new Date(endDate).toISOString(),MinEndDate:new Date(this._startDateMs+1e3).toISOString(),ProgramFields:getProgramFieldsProperty()},query||{}),categories=this.categoryOptions.categories||[],displayMovieContent=!categories.length||-1!==categories.indexOf("movies"),displaySportsContent=!categories.length||-1!==categories.indexOf("sports"),displayNewsContent=!categories.length||-1!==categories.indexOf("news"),displayKidsContent=!categories.length||-1!==categories.indexOf("kids"),displaySeriesContent=!categories.length||-1!==categories.indexOf("series");displayMovieContent&&displaySportsContent&&displayNewsContent&&displayKidsContent?(epgQuery.IsMovie=null,epgQuery.IsSports=null,epgQuery.IsKids=null,epgQuery.IsNews=null,epgQuery.IsSeries=null):(displayNewsContent&&(epgQuery.IsNews=!0),displaySportsContent&&(epgQuery.IsSports=!0),displayKidsContent&&(epgQuery.IsKids=!0),displayMovieContent&&(epgQuery.IsMovie=!0),displaySeriesContent&&(epgQuery.IsSeries=!0));var userChannelOrder=userSettings.get("livetv-channelorder");return"DatePlayed"===userChannelOrder?(apiClient.isMinServerVersion("4.4.0.20")?epgQuery.SortBy="DatePlayed,ChannelNumber,SortName":epgQuery.SortBy="DatePlayed",epgQuery.SortOrder="Descending"):"SortName"===userChannelOrder?apiClient.isMinServerVersion("4.4.0.20")&&(epgQuery.SortBy="SortName",epgQuery.SortOrder="Ascending"):apiClient.isMinServerVersion("4.4.0.20")&&(epgQuery.SortBy="ChannelNumber,SortName",epgQuery.SortOrder="Ascending"),apiClient.getEpg(epgQuery).then(function(result){for(var items=result.Items,i=(getTimeBlockStart(this,0).toString(),0),length=items.length;i<length;i++){var epgRow=items[i];epgRow.ChannelId=epgRow.Channel.Id,epgRow.ProgramMap=getProgramMap(epgRow)}return result}.bind(this))},Guide.prototype.startDataLoadTimer=function(loadDataInfo){this.cancelDataLoadTimer(),this._loadDataInfo=loadDataInfo,this.getProgramsTimeout=setTimeout(this.boundLoadPrograms,100)},Guide.prototype.cancelDataLoadTimer=function(){var timeout=this.getProgramsTimeout;timeout&&(clearTimeout(timeout),this.getProgramsTimeout=null,this._loadDataInfo=null)},Guide.prototype.getListOptions=function(items){var programRenderOptions={categories:this.categoryOptions.categories,startDateMs:this._startDateMs,endDateMs:this._endDateMs};return gridRowRenderer.setListOptions([],programRenderOptions),this.programRenderOptions=programRenderOptions,{renderer:gridRowRenderer,options:{categories:this.categoryOptions.categories,startDateMs:this._startDateMs,endDateMs:this._endDateMs},virtualScrollLayout:"vertical-grid"}},Guide.prototype.destroy=function(){this.cancelDataLoadTimer();var options=this.options;if(this.stopCurrentTimeUpdateInterval(),options){var context=options.element;itemShortcuts.off(context);var onTimerCreatedFn=this.onTimerCreatedFn;onTimerCreatedFn&&(events.off(serverNotifications,"TimerCreated",onTimerCreatedFn),this.onTimerCreatedFn=null);var onSeriesTimerCreatedFn=this.onSeriesTimerCreatedFn;onSeriesTimerCreatedFn&&(events.off(serverNotifications,"SeriesTimerCreated",onSeriesTimerCreatedFn),this.onSeriesTimerCreatedFn=null);var onTimerCancelledFn=this.onTimerCancelledFn;onTimerCancelledFn&&(events.off(serverNotifications,"TimerCancelled",onTimerCancelledFn),this.onTimerCancelledFn=null);var onSeriesTimerCancelledFn=this.onSeriesTimerCancelledFn;onSeriesTimerCancelledFn&&(events.off(serverNotifications,"SeriesTimerCancelled",onSeriesTimerCancelledFn),this.onSeriesTimerCancelledFn=null);var channelCellResizeObserver=this.channelCellResizeObserver;channelCellResizeObserver&&(channelCellResizeObserver.disconnect(),this.channelCellResizeObserver=null),this.itemsContainer=null,this.currentTimeIndicatorDot=null,this.scroller=null,this.options=null,this._endDateMs=null,this._startDateMs=null,this.channelCellWidth=null,this.scrollerOffsetWidth=null,this.scrollerScrollWidth=null,this.programCache=null,this.btnDateText=null,this.timeslotsContainer=null}},Guide});