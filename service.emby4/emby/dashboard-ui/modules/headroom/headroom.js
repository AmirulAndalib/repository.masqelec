define(["dom","layoutManager","browser","apphost","events","Modernizr","css!./headroom"],function(dom,layoutManager,browser,appHost,events,Modernizr){"use strict";var windowInsetTop=0;function onWindowInsetsChanged(e,insets){windowInsetTop=insets.top}function Headroom(elems,options){options=options||{},this.lastScrollY=0,this.elems=elems,this.scrollElementForEvents=options.scroller||window,this.scroller=this.scrollElementForEvents,this.updateFn=this.update.bind(this),this.offset=options.offset,this.initialised=!1}return Headroom.prototype={constructor:Headroom,init:function(){appHost.getWindowInsets&&(windowInsetTop=appHost.getWindowInsets().top),events.on(appHost,"windowinsetschanged",onWindowInsetsChanged),this.onHeadroomClearedExternallyFn=function(){this.transform=null}.bind(this),this.onHeadroomForceClearedExternallyFn=function(){this.transform=null,this.setTransform(0)}.bind(this);var elems=this.elems;this.elems=[];for(var i=0,length=elems.length;i<length;i++)this.add(elems[i]);return this},add:function(elem){var elems=this.elems;Modernizr.csstransforms&&-1===elems.indexOf(elem)&&(this.initElem(elem),elems.push(elem),this.attachEvent())},initElem:function(elem){var onHeadroomClearedExternallyFn=this.onHeadroomClearedExternallyFn,onHeadroomForceClearedExternallyFn=this.onHeadroomForceClearedExternallyFn;elem.addEventListener("clearheadroom",onHeadroomClearedExternallyFn),elem.addEventListener("forceclearheadroom",onHeadroomForceClearedExternallyFn)},remove:function(elem){var onHeadroomClearedExternallyFn=this.onHeadroomClearedExternallyFn,onHeadroomForceClearedExternallyFn=this.onHeadroomForceClearedExternallyFn;elem.removeEventListener("clearheadroom",onHeadroomClearedExternallyFn),elem.removeEventListener("forceclearheadroom",onHeadroomForceClearedExternallyFn);var i=this.elems.indexOf(elem);-1!==i&&this.elems.splice(i,1)},pause:function(){this.paused=!0},resume:function(){this.paused=!1},destroy:function(){events.off(appHost,"windowinsetschanged",onWindowInsetsChanged),this.initialised=!1,this.lastScrollY=null;for(var i=0,length=this.elems.length;i<length;i++)this.elems[i].classList;var scroller=this.scrollElementForEvents;scroller&&(scroller.removeScrollEventListener?scroller.removeScrollEventListener(this.updateFn,{capture:!1,passive:!0}):dom.removeEventListener(scroller,"scroll",this.updateFn,{capture:!1,passive:!0})),this.scrollElementForEvents=null,this.scroller=null,this.elems=[],this.options=null},attachEvent:function(){if(!this.initialised){this.lastScrollY=this.getScrollY(),this.initialised=!0;var scroller=this.scrollElementForEvents;if(scroller)scroller.addScrollEventListener?scroller.addScrollEventListener(this.updateFn,{capture:!1,passive:!0}):dom.addEventListener(scroller,"scroll",this.updateFn,{capture:!1,passive:!0});this.update()}},setTransform:function(value){if(value!==this.transform){var isActive;0===(this.transform=value)?value="none":isActive=(value=1===value?windowInsetTop?"translateY(calc(-100% + "+windowInsetTop+"px))":"translateY(-100%)":"translateY(-"+(value+windowInsetTop)+"px)",!0);for(var elems=this.elems,i=0,length=elems.length;i<length;i++){var elem=elems[i];windowInsetTop&&(isActive?elem.classList.add("headroom-active"):elem.classList.remove("headroom-active")),elem.style.transform=value}}},getScrollY:function(){var scroller=this.scroller;if(scroller.getScrollPosition)return scroller.getScrollPosition();var scrollTop=scroller.scrollTop;return void 0!==scrollTop?scrollTop:(document.scrollingElement||document.documentElement||document.body).scrollTop},update:function(e){if(!this.paused){var currentScrollY=this.getScrollY();if(currentScrollY<0)return this.lastScrollY=currentScrollY,void(this.scrolled=!1);var lastScrollY=this.lastScrollY,isTv=layoutManager.tv,scrollingDown=lastScrollY<currentScrollY,top=currentScrollY<=(isTv?130:0),toleranceExceeded=0<Math.abs(currentScrollY-lastScrollY);scrollingDown&&!top&&toleranceExceeded?this.setTransform(1):(!scrollingDown&&!isTv&&toleranceExceeded||top)&&this.setTransform(0),this.lastScrollY=currentScrollY,this.scrolled=!1}}},Headroom});