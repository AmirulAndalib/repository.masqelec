define(["dom","commandProcessor","userSettings","apphost","globalize","connectionManager","itemHelper","appRouter","playbackManager","layoutManager","loading","appSettings","browser","actionsheet"],function(dom,commandProcessor,userSettings,appHost,globalize,connectionManager,itemHelper,appRouter,playbackManager,layoutManager,loading,appSettings,browser,actionsheet){"use strict";function getCommands(options){var commands=[],item=options.item,canPlay=playbackManager.canPlay(item),user=options.user,apiClient=connectionManager.getApiClient(item),restrictOptions=(browser.web0s||browser.netcast)&&"6da60dd6edfc4508bca2c434d4400816"===apiClient.serverId()||browser.tizen&&!browser.tizenSideload;if(canPlay&&"Photo"!==item.MediaType&&"Program"!==item.Type&&(!1!==options.play&&commands.push({name:globalize.translate("Play"),id:"resume",icon:"play_arrow"}),options.playAllFromHere&&"Program"!==item.Type&&"Recording"!==item.Type&&"TvChannel"!==item.Type&&commands.push({name:globalize.translate("PlayAllFromHere"),id:"playallfromhere",icon:"play_arrow"})),playbackManager.canQueue(item)&&(!1!==options.queue&&commands.push({name:globalize.translate("HeaderAddToPlayQueue"),id:"queue",icon:"playlist_add"}),!1!==options.queue&&commands.push({name:globalize.translate("HeaderPlayNext"),id:"queuenext",icon:"playlist_add"})),(item.IsFolder||"MusicArtist"===item.Type||"MusicGenre"===item.Type)&&"livetv"!==item.CollectionType&&canPlay&&!1!==options.shuffle&&commands.push({name:globalize.translate("Shuffle"),id:"shuffle",icon:"shuffle"}),"Audio"!==item.MediaType&&"MusicAlbum"!==item.Type&&"MusicArtist"!==item.Type||!1===options.instantMix||itemHelper.isLocalItem(item)||commands.push({name:globalize.translate("HeaderInstantMix"),id:"instantmix",icon:"shuffle"}),commands.length&&commands.push({divider:!0}),itemHelper.supportsAddingToCollection(item)&&commands.push({name:globalize.translate("HeaderAddToCollection"),id:"addtocollection",icon:"playlist_add"}),itemHelper.supportsAddingToPlaylist(item)&&commands.push({name:globalize.translate("HeaderAddToPlaylist"),id:"addtoplaylist",icon:"playlist_add"}),user&&("Timer"===item.Type&&user.Policy.EnableLiveTvManagement&&!1!==options.cancelTimer&&commands.push({name:globalize.translate("HeaderCancelRecording"),id:"canceltimer",icon:"fiber_manual_record"}),"SeriesTimer"===item.Type&&user.Policy.EnableLiveTvManagement&&!1!==options.cancelTimer&&commands.push({name:globalize.translate("HeaderCancelSeries"),id:"cancelseriestimer",icon:"fiber_smart_record"})),"VirtualFolder"===item.Type&&user.Policy.IsAdministrator&&commands.push({name:globalize.translate("ButtonChangeContentType"),id:"changelibrarycontenttype",icon:"edit"}),"Server"===item.Type&&commands.push({name:globalize.translate("Connect"),id:"connecttoserver",icon:"&#xE63E;"}),restrictOptions||itemHelper.canConvert(item,user,apiClient)&&commands.push({name:globalize.translate("Convert"),id:"convert",icon:"transform"}),user&&(user.Policy.IsAdministrator&&"User"===item.Type&&item.Id!==apiClient.getCurrentUserId()&&commands.push({name:globalize.translate("Delete"),id:"delete",icon:"delete"}),user.Policy.IsAdministrator&&"Device"===item.Type&&item.Id!==apiClient.deviceId()&&commands.push({name:globalize.translate("Delete"),id:"delete",icon:"delete"})),"Server"===item.Type&&commands.push({name:globalize.translate("Delete"),id:"delete",icon:"delete"}),item.CanDelete&&!1!==options.deleteItem&&("Playlist"===item.Type||item.Type,commands.push({name:globalize.translate("Delete"),id:"delete",icon:"delete"})),item.CanDownload&&appHost.supports("filedownload")&&commands.push({name:globalize.translate("Download"),id:"download",icon:"cloud_download"}),appHost.supports("sync")&&!1!==options.syncLocal&&itemHelper.canSync(user,item)&&commands.push({name:globalize.translate("Download"),id:"synclocal",icon:"cloud_download"}),!restrictOptions){if(!1!==options.sync&&itemHelper.canSync(user,item)&&commands.push({name:globalize.translate("HeaderDownloadToDots"),id:"sync",icon:"cloud_download"}),itemHelper.canEdit(user,item)&&!1!==options.edit&&"SeriesTimer"!==item.Type){var text="Timer"===item.Type||"SeriesTimer"===item.Type||"User"===item.Type||"VirtualFolder"===item.Type?globalize.translate("Edit"):globalize.translate("HeaderEditMetadata");commands.push({name:text,id:"edit",icon:"edit"})}itemHelper.canEditImages(user,item)&&!1!==options.editImages&&commands.push({name:globalize.translate("HeaderEditImages"),id:"editimages",icon:"photo"}),itemHelper.canEditSubtitles(user,item)&&!1!==options.editSubtitles&&commands.push({name:globalize.translate("HeaderEditSubtitles"),id:"editsubtitles",icon:"closed_captions"}),!1!==options.identify&&itemHelper.canIdentify(user,item)&&commands.push({name:globalize.translate("Identify"),id:"identify",icon:"edit"}),options.multiSelect&&!layoutManager.tv&&commands.push({name:globalize.translate("MultiSelect"),id:"multiselect",icon:"select_all",hideWithFinePointer:!0}),itemHelper.canRefreshMetadata(item,user)&&commands.push({name:globalize.translate("HeaderRefreshMetadata"),id:"refresh",icon:"refresh"})}return item.PlaylistItemId&&options.playlistId&&commands.push({name:globalize.translate("HeaderRemoveFromPlaylist"),id:"removefromplaylist",icon:"remove_circle"}),options.collectionId&&commands.push({name:globalize.translate("HeaderRemoveFromCollection"),id:"removefromcollection",icon:"remove_circle"}),"Plugin"===item.Type&&user.Policy.IsAdministrator&&item.ConfigPageUrl&&commands.push({name:globalize.translate("Settings"),id:"open",icon:"settings"}),user&&("VirtualFolder"===item.Type&&user.Policy.IsAdministrator&&(commands.push({name:globalize.translate("Remove"),id:"removelibrary",icon:"remove_circle"}),commands.push({name:globalize.translate("Rename"),id:"renamelibrary",icon:"edit"})),itemHelper.canRefreshMetadata(item,user)&&item.IsFolder&&"Playlist"!==item.Type&&"Genre"!==item.Type&&"MusicGenre"!==item.Type&&"GameGenre"!==item.Type&&"Channel"!==item.Type&&"MusicArtist"!==item.Type&&commands.push({name:globalize.translate("HeaderScanLibraryFiles"),id:"scan",icon:"refresh"})),restrictOptions||!1!==options.share&&itemHelper.canShare(item,user)&&commands.push({name:globalize.translate("Share"),id:"share",icon:"share"}),"Recording"===item.Type&&"InProgress"===item.Status&&user.Policy.EnableLiveTvManagement&&!1!==options.cancelTimer&&commands.push({name:globalize.translate("HeaderStopRecording"),id:"canceltimer",icon:"fiber_manual_record"}),"Plugin"===item.Type&&user.Policy.IsAdministrator&&commands.push({name:globalize.translate("Uninstall"),id:"delete",icon:"delete"}),!1!==options.openAlbum&&item.AlbumId&&"Photo"!==item.MediaType&&commands.push({name:globalize.translate("HeaderViewAlbum"),id:"album",icon:"&#xE019;"}),!1!==options.openArtist&&item.ArtistItems&&item.ArtistItems.length&&commands.push({name:globalize.translate("HeaderViewArtist"),id:"artist",icon:"&#xE7FD;"}),"Server"===item.Type&&apiClient.supportsWakeOnLan()&&commands.push({name:globalize.translate("HeaderWakeServer"),id:"wakeserver",icon:"&#xE63E;"}),commands}function getResolveFunction(resolve,id,changed,deleted){return function(){resolve({command:id,updated:changed,deleted:deleted})}}function getResolveFn(id,changed,deleted){return function(){return Promise.resolve({command:id,updated:changed,deleted:deleted})}}function executeCommand(item,id,options){var itemId=item.Id,serverId=item.ServerId,apiClient=connectionManager.getApiClient(item);switch(id){case"edit":return function(apiClient,item,button){var serverId=apiClient.serverId();return"Device"!==item.Type&&"User"!==item.Type&&"SeriesTimer"!==item.Type?"Timer"!==item.Type?"VirtualFolder"!==item.Type?require(["metadataEditor"]).then(function(responses){return responses[0].show(item.Id,serverId)}):function(item,button){var view=dom.parentWithClass(button,"page"),refreshLibrary=!!button&&"true"===view.getAttribute("data-refreshlibrary");return require(["medialibraryeditor"]).then(function(responses){return(new responses[0]).show({refresh:refreshLibrary,library:item})})}(item,button):require(["recordingEditor"]).then(function(responses){return responses[0].show(item.Id,serverId)}):(appRouter.showItem(item),Promise.resolve())}(apiClient,item,options.positionTo).then(getResolveFn(id,!0),getResolveFn(id));case"renamelibrary":return function(apiClient,virtualFolder,button){return require(["prompt"]).then(function(responses){return(0,responses[0])({label:globalize.translate("LabelNewName"),confirmText:globalize.translate("ButtonRename"),value:virtualFolder.Name}).then(function(newName){if(newName&&newName!==virtualFolder.Name){var refreshAfterChange="true"===dom.parentWithClass(button,"page").getAttribute("data-refreshlibrary");return apiClient.renameVirtualFolder(virtualFolder,newName,refreshAfterChange)}})})}(apiClient,item,options.positionTo).then(getResolveFn(id,!0),getResolveFn(id));case"removelibrary":return function(apiClient,virtualFolder,button){var msg=globalize.translate("MessageAreYouSureYouWishToRemoveMediaFolder");virtualFolder.Locations.length&&(msg+="<br/><br/>"+globalize.translate("MessageTheFollowingLocationWillBeRemovedFromLibrary")+"<br/><br/>",msg+=virtualFolder.Locations.join("<br/>"));return require(["confirm"]).then(function(responses){return(0,responses[0])(msg,globalize.translate("HeaderRemoveMediaFolder")).then(function(){var refreshAfterChange="true"===dom.parentWithClass(button,"page").getAttribute("data-refreshlibrary");return apiClient.removeVirtualFolder(virtualFolder,refreshAfterChange)})})}(apiClient,item,options.positionTo).then(getResolveFn(id,!0,!0),getResolveFn(id));case"changelibrarycontenttype":return(options.positionTo,require(["alert"]).then(function(responses){return(0,responses[0])({title:globalize.translate("HeaderChangeFolderType"),text:globalize.translate("HeaderChangeFolderTypeHelp")})})).then(getResolveFn(id),getResolveFn(id));case"playallfromhere":case"queueallfromhere":return getResolveFn(id)();case"wakeserver":return function(apiClient){return require(["loadingDialog"]).then(function(responses){var dlg=new responses[0]({title:globalize.translate("HeaderWakeServer"),text:globalize.translate("AttemptingWakeServer")}),showDialogPromise=dlg.show(),state={dlg:dlg,showDialogPromise:showDialogPromise};return function(apiClient){var afterWol=function(){var apiClient=this;return function(timeMs){return new Promise(function(resolve,reject){setTimeout(resolve,timeMs)})}(12e3).then(function(){return apiClient.getPublicSystemInfo()})}.bind(apiClient);return apiClient.wakeOnLan().then(afterWol,afterWol)}(apiClient).then(function(){var promise=this.showDialogPromise.then(function(){return require(["alert"]).then(function(responses){return responses[0]({text:globalize.translate("WakeServerSuccess"),title:globalize.translate("HeaderWakeServer")}).catch(getResolvedPromise)})}),dlg=this.dlg;return dlg.hide(),dlg.destroy(),promise}.bind(state),function(){var promise=this.showDialogPromise.then(function(){return require(["alert"]).then(function(responses){return responses[0]({text:globalize.translate("WakeServerError"),title:globalize.translate("HeaderWakeServer")}).catch(getResolvedPromise)})}),dlg=this.dlg;return dlg.hide(),dlg.destroy(),promise}.bind(state))})}(apiClient).then(getResolveFn(id),getResolveFn(id));case"connecttoserver":return function(apiClient,item){if(loading.show(),"AddServer"===item.Type||"Downloads"===item.Type)return appRouter.showItem(item);if("EmbyConnect"===item.Type)return appRouter.showConnectLogin();item=connectionManager.getServerInfo(item.Id)||item,connectionManager.connectToServer(item,{enableAutoLogin:appSettings.enableAutoLogin()}).then(function(result){appRouter.handleConnectionResult(result)})}(0,item),getResolveFn(id)();case"open":return appRouter.showItem(item),getResolveFn(id)();case"play":return play(item,!1),getResolveFn(id)();case"resume":return play(item,!0),getResolveFn(id)();case"queue":return play(item,!1,!0),getResolveFn(id)();case"queuenext":return play(item,!1,!0,!0),getResolveFn(id)();case"shuffle":return playbackManager.shuffle(item),getResolveFn(id)();case"instantmix":return playbackManager.instantMix(item),getResolveFn(id)();case"album":return appRouter.showItem(item.AlbumId,item.ServerId),getResolveFn(id)();case"artist":return appRouter.showItem(item.ArtistItems[0].Id,item.ServerId),getResolveFn(id)();case"canceltimer":return function(apiClient,item){return require(["recordingHelper"]).then(function(responses){var timerId=item.TimerId||item.Id;return responses[0].cancelTimerWithConfirmation(timerId,item.ServerId)})}(0,item).then(getResolveFn(id,!0,!0),getResolveFn(id));case"cancelseriestimer":return function(apiClient,item){return require(["recordingHelper"]).then(function(responses){return responses[0].cancelSeriesTimerWithConfirmation(item.Id,item.ServerId)})}(0,item).then(getResolveFn(id,!0,!0),getResolveFn(id));case"refresh":return function(apiClient,item,mode){require(["refreshDialog"],function(refreshDialog){new refreshDialog({items:[item],mode:mode}).show()})}(0,item),getResolveFn(id)();case"scan":return function(apiClient,item){apiClient.refreshItem(item.Id,{Recursive:!0,ImageRefreshMode:"Default",MetadataRefreshMode:"Default",ReplaceAllImages:!1,ReplaceAllMetadata:!1}).then(function(){sendToast(globalize.translate("ScanningLibraryFilesDots"))})}(apiClient,item),getResolveFn(id)();case"delete":return commandProcessor.executeCommand(id,item,options).then(getResolveFn(id,!0,!0),getResolveFn(id));case"multiselect":return function(apiClient,item,options){dom.parentWithClass(options.positionTo,"itemsContainer").showMultiSelect(options.positionTo,!0)}(0,0,options),getResolveFn(id)();case"share":return navigator.share({title:item.Name,text:item.Overview,url:"Photo"===item.Type?apiClient.getItemDownloadUrl(item.Id):apiClient.getUrl("share").replace("/share","")}).then(getResolveFn(id));case"addtocollection":return function(itemId,serverId){return require(["addToList"]).then(function(responses){return(new responses[0]).show({items:[itemId],serverId:serverId,type:"Collection"})})}(item.Id,item.ServerId).then(getResolveFn(id,!0),getResolveFn(id));case"addtoplaylist":return function(itemId,serverId){return require(["addToList"]).then(function(responses){return(new responses[0]).show({items:[itemId],serverId:serverId,type:"Playlist"})})}(item.Id,item.ServerId).then(getResolveFn(id,!0),getResolveFn(id));case"identify":return commandProcessor.executeCommand(id,item,options).then(getResolveFn(id,!0),getResolveFn(id))}return new Promise(function(resolve,reject){switch(id){case"editsubtitles":require(["subtitleEditor"],function(subtitleEditor){subtitleEditor.show(itemId,serverId).then(getResolveFunction(resolve,id,!0),getResolveFunction(resolve,id))});break;case"editimages":require(["imageEditor"],function(imageEditor){imageEditor.show({itemId:itemId,serverId:serverId}).then(getResolveFunction(resolve,id,!0),getResolveFunction(resolve,id))});break;case"convert":require(["syncDialog"],function(syncDialog){syncDialog.showMenu({items:[item],serverId:serverId,mode:"convert"})}),getResolveFunction(resolve,id)();break;case"sync":require(["syncDialog"],function(syncDialog){syncDialog.showMenu({items:[item],serverId:serverId,mode:"sync"})}),getResolveFunction(resolve,id)();break;case"synclocal":require(["syncDialog"],function(syncDialog){syncDialog.showMenu({items:[item],serverId:serverId,mode:"download"})}),getResolveFunction(resolve,id)();break;case"removefromplaylist":apiClient.ajax({url:apiClient.getUrl("Playlists/"+options.playlistId+"/Items",{EntryIds:[item.PlaylistItemId].join(",")}),type:"DELETE"}).then(function(){getResolveFunction(resolve,id,!0)()});break;case"removefromcollection":apiClient.ajax({type:"DELETE",url:apiClient.getUrl("Collections/"+options.collectionId+"/Items",{Ids:[item.Id].join(",")})}).then(function(){getResolveFunction(resolve,id,!0)()});break;default:commandProcessor.executeCommand(id,item,options).then(resolve,reject)}})}function sendToast(text){require(["toast"],function(toast){toast(text)})}function play(item,resume,queue,queueNext){var method=queue?queueNext?"queueNext":"queue":"play",startPosition=item.StartPositionTicks||0;resume&&(startPosition=null),playbackManager[method]({items:[item],startPositionTicks:startPosition}),(queue||queueNext)&&sendToast(globalize.translate("AddedToPlayQueue"))}function getResolvedPromise(){return Promise.resolve()}return{getCommands:getCommands,show:function(options){var commands=getCommands(options);return commands.length?actionsheet.show({items:commands,positionTo:options.positionTo,resolveOnClick:["share"]}).then(function(id){return executeCommand(options.item,id,options)}):Promise.reject()}}});