define(["dom","itemShortcuts","itemHelper","mediaInfo","indicators","connectionManager","layoutManager","globalize","datetime","apphost","imageLoader","focusManager","css!./listview","emby-ratingbutton","emby-playstatebutton","embyProgressBarStyle","emby-linkbutton"],function(dom,itemShortcuts,itemHelper,mediaInfo,indicators,connectionManager,layoutManager,globalize,datetime,appHost,imageLoader,focusManager){"use strict";var supportsNativeLazyLoading="loading"in HTMLImageElement.prototype;function getIndex(item,options){if("disc"!==options.index)return"";var parentIndexNumber=item.ParentIndexNumber;return 1===parentIndexNumber?"":null==parentIndexNumber?"":globalize.translate("ValueDiscNumber",parentIndexNumber)}function getTextLinesHtml(textlines,isLargeStyle){for(var html="",isFirst=!0,i=0,length=textlines.length;i<length;i++){var text=textlines[i];text&&(html+=isFirst?isLargeStyle?'<h3 class="listItemBodyText listItemBodyText-nowrap">':'<div class="listItemBodyText listItemBodyText-nowrap">':'<div class="listItemBodyText listItemBodyText-secondary listItemBodyText-nowrap">',html+=text,html+=isFirst&&isLargeStyle?"</h3>":"</div>",isFirst=!1)}return html}function getId(item){return item.Id}function getListItemHtml(item,index,options){var enableOverview=options.enableOverview,enableSideMediaInfo=options.enableSideMediaInfo,clickEntireItem=options.clickEntireItem,isLargeStyle=options.isLargeStyle,enableContentWrapper=options.enableContentWrapper,tagName=options.tagName,action=options.action,html="",downloadWidth=80;isLargeStyle&&(downloadWidth=600),enableContentWrapper&&(html+='<div class="listItem-content">');var apiClient=connectionManager.getApiClient(item.ServerId),itemType=item.Type;if(!1!==options.image){var imgUrl="channel"===options.imageSource?function(item,apiClient,width){var options={width:width,type:"Primary"};return item.ChannelId&&item.ChannelPrimaryImageTag?(options.tag=item.ChannelPrimaryImageTag,apiClient.getScaledImageUrl(item.ChannelId,options)):null}(item,apiClient,downloadWidth):function(item,apiClient,width){var options={width:width,type:"Primary"};return item.ImageTags&&item.ImageTags.Primary?(options.tag=item.ImageTags.Primary,apiClient.getScaledImageUrl(item.Id,options)):item.AlbumId&&item.AlbumPrimaryImageTag?(options.tag=item.AlbumPrimaryImageTag,apiClient.getScaledImageUrl(item.AlbumId,options)):item.SeriesId&&item.SeriesPrimaryImageTag?(options.tag=item.SeriesPrimaryImageTag,apiClient.getScaledImageUrl(item.SeriesId,options)):item.ParentPrimaryImageTag?(options.tag=item.ParentPrimaryImageTag,apiClient.getScaledImageUrl(item.ParentPrimaryImageItemId,options)):item.UserPrimaryImageTag?(options.tag=item.UserPrimaryImageTag,apiClient.getUserImageUrl(item.UserId,options)):null}(item,apiClient,downloadWidth),imageContainerClass="listItemImageContainer",imageClass="listItemImage";isLargeStyle&&(imageContainerClass+=" listItemImageContainer-large",layoutManager.tv&&(imageContainerClass+=" listItemImageContainer-large-tv")),options.roundImage&&(imageClass+=" listItemImage-round");var playOnImageClick=options.imagePlayButton&&!layoutManager.tv;if(clickEntireItem||(imageContainerClass+=" itemAction"),options.playlistItemId&&options.playlistItemId===item.PlaylistItemId&&(imageContainerClass+=" playlistIndexIndicatorImage"),html+='<div data-action="'+(playOnImageClick?"resume":action)+'" class="'+imageContainerClass+'">',imgUrl)supportsNativeLazyLoading||2===options.lazy?html+='<img class="'+imageClass+'" loading="lazy" src="'+imgUrl+'" />':html+='<img class="'+imageClass+' lazy" src="data:," data-src="'+imgUrl+'" alt />';else if(options.enableDefaultIcon){var icon="ActivityLogEntry"===itemType?"&#xE878;":"";if(icon){var color="Error"===item.Severity||"Fatal"===item.Severity||"Warn"===item.Severity?"background-color:#cc0000;":"";html+='<i class="listItemIcon md-icon"'+(color?' style="'+color+'"':"")+">"+icon+"</i>"}}var indicatorsHtml=indicators.getPlayedIndicatorHtml(item,"listItem");indicatorsHtml&&(html+='<div class="indicators listItemIndicators">'+indicatorsHtml+"</div>"),playOnImageClick&&(html+='<button type="button" is="paper-icon-button-light" class="listItemImageButton itemAction" data-action="resume"><i class="md-icon listItemImageButton-icon">&#xE037;</i></button>');var progressHtml=indicators.getProgressBarHtml(item,{containerClass:"listItemProgressBar"});progressHtml&&(html+=progressHtml),html+="</div>"}options.showIndexNumberLeft&&(html+='<div class="listItem-indexnumberleft secondaryText">',null==item.IndexNumber?html+="&nbsp;":html+=item.IndexNumber,html+="</div>");var textlines=[];options.showProgramDateTime&&textlines.push(datetime.toLocaleString(datetime.parseISO8601Date(item.StartDate),{weekday:"long",month:"short",day:"numeric",hour:"numeric",minute:"2-digit"})),options.showProgramTime&&textlines.push(datetime.getDisplayTime(datetime.parseISO8601Date(item.StartDate))),options.showChannel&&item.ChannelName&&textlines.push(dom.htmlEncode(item.ChannelName));var parentTitle=null;options.showParentTitle&&("Episode"===itemType?parentTitle=item.SeriesName:(item.IsSeries||item.EpisodeTitle&&item.Name)&&(parentTitle=item.Name));var displayName=itemHelper.getDisplayName(item,{includeParentInfo:options.includeParentInfoInTitle});if(options.showIndexNumber&&null!=item.IndexNumber&&(displayName=item.IndexNumber+". "+displayName),options.showParentTitle&&options.parentTitleWithTitle?(displayName&&(parentTitle&&(parentTitle+=" - "),parentTitle=(parentTitle||"")+displayName),textlines.push(dom.htmlEncode(parentTitle||""))):options.showParentTitle&&textlines.push(dom.htmlEncode(parentTitle||"")),displayName&&!options.parentTitleWithTitle&&textlines.push(dom.htmlEncode(displayName)),item.IsFolder)!1!==options.artist&&item.AlbumArtist&&"MusicAlbum"===itemType&&textlines.push(dom.htmlEncode(item.AlbumArtist));else{var showArtist=!0===options.artist,artistItems=item.ArtistItems;if(!showArtist&&!1!==options.artist){var containerAlbumArtistIds=options.containerAlbumArtistIds;artistItems&&artistItems.length?(1<artistItems.length||!containerAlbumArtistIds||1!==containerAlbumArtistIds.length||-1===containerAlbumArtistIds.indexOf(artistItems[0].Id))&&(showArtist=!0):showArtist=!0}showArtist&&artistItems&&"MusicAlbum"!==itemType&&textlines.push(dom.htmlEncode(artistItems.map(function(a){return a.Name}).join(", ")||""))}"Game"===itemType?textlines.push(dom.htmlEncode(item.GameSystem)):"TvChannel"===itemType&&item.CurrentProgram&&textlines.push(dom.htmlEncode(itemHelper.getDisplayName(item.CurrentProgram))),options.showDateModified&&textlines.push(datetime.toLocaleString(datetime.parseISO8601Date(item.DateModified,!0))),options.showDate&&textlines.push(datetime.toLocaleString(datetime.parseISO8601Date(item.Date,!0))),options.showShortOverview&&textlines.push(item.ShortOverview?dom.htmlEncode(item.ShortOverview):"&nbsp;");var cssClass="listItemBody";clickEntireItem||(cssClass+=" itemAction"),!1===options.image&&(cssClass+=" listItemBody-noleftpadding"),html+='<div class="'+cssClass+'">';var listItemHref;if(html+=getTextLinesHtml(textlines,isLargeStyle),!1!==options.mediaInfo&&!enableSideMediaInfo){html+='<div class="listItemMediaInfo listItemBodyText listItemBodyText-secondary listItemBodyText-nowrap">'+mediaInfo.getPrimaryMediaInfoHtml(item,{episodeTitle:!1,originalAirDate:!1,subtitles:!1,endsAt:!1})+"</div>"}if(enableOverview&&item.Overview&&(html+='<div class="listItem-overview listItemBodyText listItemBodyText-secondary">',html+=dom.htmlEncode(item.Overview),html+="</div>"),html+="</div>",!1!==options.mediaInfo&&enableSideMediaInfo&&(html+='<div class="listItemMediaInfo secondaryText">'+mediaInfo.getPrimaryMediaInfoHtml(item,{year:!1,container:!1,episodeTitle:!1,criticRating:!1,endsAt:!1})+"</div>"),options.recordButton||"Timer"!==itemType&&"Program"!==itemType||(html+=indicators.getTimerIndicator(item).replace("indicatorIcon","indicatorIcon listItemAside")),!clickEntireItem){if(options.addToListButton&&(html+='<button type="button" is="paper-icon-button-light" class="listItemButton itemAction" data-action="addtoplaylist"><i class="md-icon">&#xE03B;</i></button>'),!1!==options.moreButton&&"Program"!==itemType&&(html+='<button type="button" is="paper-icon-button-light" class="listItemButton listItemContextMenuButton itemAction" data-action="menu"><i class="md-icon">&#xE5D3;</i></button>'),options.infoButton&&(html+='<button type="button" is="paper-icon-button-light" class="listItemButton itemAction" data-action="link"><i class="md-icon">&#xE88F;</i></button>'),options.overviewButton&&item.Overview&&(html+='<button type="button" is="paper-icon-button-light" class="listItemButton itemAction" data-action="overview"><i class="md-icon">&#xE88F;</i></button>'),options.rightButtons&&(html+=function(options){for(var html="",i=0,length=options.rightButtons.length;i<length;i++){var button=options.rightButtons[i];html+='<button type="button" is="paper-icon-button-light" class="listItemButton itemAction" data-action="custom" data-customaction="'+button.id+'" title="'+button.title+'"><i class="md-icon">'+button.icon+"</i></button>"}return html}(options)),!1!==options.enableUserDataButtons){html+='<span class="listViewUserDataButtons flex align-items-center">';var userData=item.UserData||{},likes=null==userData.Likes?"":userData.Likes;itemHelper.canMarkPlayed(item)&&(html+='<button type="button" is="emby-playstatebutton" type="button" class="listItemButton paper-icon-button-light" data-id="'+item.Id+'" data-serverid="'+item.ServerId+'" data-itemtype="'+itemType+'" data-played="'+userData.Played+'"><i class="md-icon">&#xE5CA;</i></button>'),itemHelper.canRate(item)&&(html+='<button type="button" is="emby-ratingbutton" type="button" class="listItemButton paper-icon-button-light" data-id="'+item.Id+'" data-serverid="'+item.ServerId+'" data-itemtype="'+itemType+'" data-likes="'+likes+'" data-isfavorite="'+userData.IsFavorite+'"><i class="md-icon">&#xE87D;</i></button>'),html+="</span>"}options.dragHandle&&(html+='<i class="listViewDragHandle md-icon listItemIcon listItemIcon-transparent">&#xE25D;</i>')}if(enableContentWrapper&&(html+="</div>",enableOverview&&item.Overview&&(html+='<div class="listItem-bottomoverview secondaryText">',html+=dom.htmlEncode(item.Overview),html+="</div>")),"a"===options.tagName&&(apiClient.isMinServerVersion("4.2.0.11")?(listItemHref=apiClient.getUrl("System/Logs/"+item.Name),listItemHref+="?api_key="+apiClient.accessToken()):(listItemHref=apiClient.getUrl("System/Logs/Log",{name:item.Name}),listItemHref+="&api_key="+apiClient.accessToken())),options.listItemParts){var attributes=itemShortcuts.getShortcutAttributes(item,options);return action&&attributes.push({name:"data-action",value:action}),attributes.push({name:"data-index",value:index}),listItemHref&&(attributes.push({name:"href",value:listItemHref}),attributes.push({name:"target",value:"_blank"}),attributes.push({name:"is",value:"emby-linkbutton"})),options.addTabIndex&&attributes.push({name:"tabindex",value:"0"}),{attributes:attributes,html:html}}var dataAttributes=itemShortcuts.getShortcutAttributesHtml(item,options);return action&&(dataAttributes+=' data-action="'+action+'"'),dataAttributes+=' data-index="'+index+'"',options.addTabIndex&&(dataAttributes+=' tabindex="0"'),listItemHref&&(dataAttributes+=' href="'+listItemHref+'" target="_blank" is="emby-linkbutton"'),"<"+tagName+' class="'+options.className+'"'+dataAttributes+">"+html+"</"+tagName+">"}function setListOptions(items,options){options.enableContentWrapper=options.enableOverview&&!layoutManager.tv,options.containerAlbumArtistIds=(options.containerAlbumArtists||[]).map(getId);var renderingLogs=items.length&&"Log"===items[0].Type;options.clickEntireItem=!(!layoutManager.tv&&!renderingLogs),options.isLargeStyle="large"===options.imageSize,options.action=options.action||"link",options.tagName=options.clickEntireItem?renderingLogs?"a":"button":"div",options.enableSideMediaInfo=null==options.enableSideMediaInfo||options.enableSideMediaInfo;var cssClass="listItem";(options.border||!1!==options.highlight&&!layoutManager.tv)&&(cssClass+=" listItem-border"),options.clickEntireItem&&(cssClass+=" itemAction"),"div"===options.tagName&&(cssClass+=" focusable",options.addTabIndex=!0),"none"===options.action&&!options.clickEntireItem||(cssClass+=" listItemCursor"),layoutManager.tv?cssClass+=" listItem-focusscale":(cssClass+=" listItem-touchzoom",options.dragHandle||(cssClass+=" listItem-touchzoom-transition")),options.isLargeStyle&&(cssClass+=" listItem-largeImage"),options.enableContentWrapper&&(cssClass+=" listItem-withContentWrapper"),options.className=cssClass;var innerHTML="";if(!1!==options.image){var imageContainerClass="listItemImageContainer";options.isLargeStyle&&(imageContainerClass+=" listItemImageContainer-large",layoutManager.tv&&(imageContainerClass+=" listItemImageContainer-large-tv")),innerHTML+='<div class="'+imageContainerClass+'"></div>'}innerHTML+='<div class="listItemBody">';var textlines=[];if(options.showDateModified&&textlines.push("&nbsp;"),options.showDate&&textlines.push("&nbsp;"),options.showShortOverview&&textlines.push("&nbsp;"),options.showProgramDateTime&&textlines.push("&nbsp;"),options.showProgramTime&&textlines.push("&nbsp;"),options.showChannel&&textlines.push("&nbsp;"),options.showParentTitle&&options.parentTitleWithTitle?textlines.push("&nbsp;"):options.showParentTitle&&textlines.push("&nbsp;"),options.parentTitleWithTitle||textlines.push("&nbsp;"),textlines.length<1&&textlines.push("&nbsp;"),textlines.length<2&&textlines.push("&nbsp;"),innerHTML+=getTextLinesHtml(textlines,options.isLargeStyle),options.enableOverview){if(innerHTML+='<div class="listItem-overview listItemBodyText listItemBodyText-secondary">',!1!==options.mediaInfo&&!options.enableSideMediaInfo){innerHTML+='<div class="listItemMediaInfo listItemBodyText listItemBodyText-secondary listItemBodyText-nowrap"></div>'}innerHTML+="</div>"}innerHTML+="</div>",options.dragHandle&&(innerHTML+='<i class="listViewDragHandle md-icon listItemIcon listItemIcon-transparent">&#xE25D;</i>'),options.templateInnerHTML=innerHTML}function getListViewHtml(items,options){setListOptions(items,options);for(var groupTitle="",html="",i=0,length=items.length;i<length;i++){var item=items[i];if(options.showIndex){var itemGroupTitle=getIndex(item,options);itemGroupTitle!==groupTitle&&(html+=0===i?'<h2 class="listGroupHeader listGroupHeader-first">':'<h2 class="listGroupHeader">',html+=itemGroupTitle,html+="</h2>",groupTitle=itemGroupTitle)}html+=getListItemHtml(item,i,options)}return html}return supportsNativeLazyLoading=!1,{getListViewHtml:getListViewHtml,getItemsHtml:getListViewHtml,getListItemHtml:getListItemHtml,setListOptions:setListOptions,getItemParts:function(item,index,options){return options.listItemParts=!0,getListItemHtml(item,index,options)},buildItems:function(items,options){var itemsContainer=options.itemsContainer;if(document.body.contains(itemsContainer)){var parentContainer=options.parentContainer;if(parentContainer){if(!items.length)return void parentContainer.classList.add("hide");parentContainer.classList.remove("hide")}var html=getListViewHtml(items,options);itemsContainer.innerHTML=html,itemsContainer.items=items,html&&imageLoader.lazyChildren(itemsContainer),options.autoFocus&&focusManager.autoFocus(itemsContainer)}}}});