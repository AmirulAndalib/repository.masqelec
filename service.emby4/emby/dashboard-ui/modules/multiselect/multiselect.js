define(["itemHelper","browser","appStorage","apphost","loading","connectionManager","globalize","appRouter","dom","css!./multiselect"],function(itemHelper,browser,appStorage,appHost,loading,connectionManager,globalize,appRouter,dom){"use strict";var currentSelectionCommandsPanel,selectedItems=[],selectedItemsMap={},selectedElements=[];function getSelectedItemsMap(serverId){return selectedItemsMap[serverId=serverId||"0"]||(selectedItemsMap[serverId]={})}function hideSelections(){var selectionCommandsPanel=currentSelectionCommandsPanel;if(selectionCommandsPanel){selectionCommandsPanel.parentNode.removeChild(selectionCommandsPanel),currentSelectionCommandsPanel=null,selectedItems=[],selectedItemsMap={},selectedElements=[];var i,length,elems=document.querySelectorAll(".multi-select-active");for(i=0,length=elems.length;i<length;i++)elems[i].classList.remove("multi-select-active");for(i=0,length=(elems=document.querySelectorAll(".chkCardSelect:checked")).length;i<length;i++)elems[i].checked=!1;for(i=0,length=(elems=document.querySelectorAll(".item-multiselected")).length;i<length;i++)elems[i].classList.remove("item-multiselected")}}function alertText(options){return new Promise(function(resolve,reject){require(["alert"],function(alert){alert(options).then(resolve,resolve)})})}function filterItemsToOneServer(items){if(!items.length)return items;var serverId=items[0].ServerId;if(!serverId)return[];for(var list=[],i=0,length=items.length;i<length;i++){var item=items[i];item.ServerId===serverId&&list.push(item)}return list}function showNoItemsMessage(){return alertText(globalize.translate("NoSelectedItemsSupportOperation"))}function mapApiClientArrayToObject(responses){for(var map={},i=0,length=responses.length;i<length;i++){var user=responses[i];map[user.ServerId]=user}return map}function syncItems(items,users,isLocalSync){for(var list=[],i=0,length=items.length;i<length;i++){var item=items[i],user=users[item.ServerId];itemHelper.canSync(user,item)&&list.push(items[i])}if(!(items=filterItemsToOneServer(items=list)).length)return showNoItemsMessage();var serverId=items[0].ServerId;require(["syncDialog"],function(syncDialog){syncDialog.showMenu({items:items,isLocalSync:isLocalSync,serverId:serverId})})}function showMenuForSelectedItems(e){var items=selectedItems;return function(items){for(var promises=[],servers={},i=0,length=items.length;i<length;i++){var item=items[i],serverId=item.ServerId;serverId&&!servers[serverId]&&(servers[serverId]=!0,promises.push(connectionManager.getApiClient(item).getCurrentUser()))}return Promise.all(promises).then(mapApiClientArrayToObject)}(items).then(function(users){var menuItems=[];if(function(items){for(var i=0,length=items.length;i<length;i++)if(itemHelper.supportsAddingToCollection(items[i]))return!0;return!1}(items)&&menuItems.push({name:globalize.translate("HeaderAddToCollection"),id:"addtocollection",ironIcon:"add",icon:"playlist_add"}),function(items){for(var i=0,length=items.length;i<length;i++)if(itemHelper.supportsAddingToPlaylist(items[i]))return!0;return!1}(items)&&menuItems.push({name:globalize.translate("HeaderAddToPlaylist"),id:"playlist",icon:"playlist_add"}),function(items){for(var i=0,length=items.length;i<length;i++){if(items[i].CanDelete)return!0}return!1}(items)&&menuItems.push({name:globalize.translate("Delete"),id:"delete",icon:"delete"}),function(items,users){for(var i=0,length=items.length;i<length;i++){var item=items[i],user=users[item.ServerId];if(item.CanDownload&&user.Policy.EnableContentDownloading)return!0}return!1}(items,users)&&appHost.supports("filedownload")&&items.push({name:globalize.translate("ButtonDownload"),id:"download",ironIcon:"file-download"}),function(items,users){for(var i=0,length=items.length;i<length;i++){var item=items[i],user=users[item.ServerId];if(itemHelper.canSync(user,item))return!0}return!1}(items,users)&&(appHost.supports("sync")&&menuItems.push({name:globalize.translate("Download"),id:"synclocal",icon:"cloud_download"}),menuItems.push({name:globalize.translate("HeaderDownloadToDots"),id:"sync",icon:"cloud_download"})),function(items,users){for(var count=0,i=0,length=items.length;i<length;i++){var item=items[i],user=users[item.ServerId];if(itemHelper.canManageMultiVersionGrouping(item,user)&&1<++count)return!0}return!1}(items,users)&&menuItems.push({name:globalize.translate("HeaderGroupVersions"),id:"groupvideos",icon:"call_merge"}),function(items){for(var i=0,length=items.length;i<length;i++)if(itemHelper.canMarkPlayed(items[i]))return!0;return!1}(items)&&(menuItems.push({name:globalize.translate("HeaderMarkPlayed"),id:"markplayed",icon:"check"}),menuItems.push({name:globalize.translate("HeaderMarkUnplayed"),id:"markunplayed",icon:"remove"})),function(items,users){for(var i=0,length=items.length;i<length;i++){var item=items[i],user=users[item.ServerId];if(itemHelper.canRefreshMetadata(item,user))return!0}return!1}(items,users)&&menuItems.push({name:globalize.translate("HeaderRefreshMetadata"),id:"refresh",icon:"refresh"}),!menuItems.length)return alertText(globalize.translate("NoOperationsForSelectedItems"));require(["actionsheet"],function(actionsheet){actionsheet.show({items:menuItems,positionTo:e.target,callback:function(id){switch(id){case"addtocollection":!function(items){for(var list=[],i=0,length=items.length;i<length;i++)itemHelper.supportsAddingToCollection(items[i])&&list.push(items[i]);if(!(items=filterItemsToOneServer(items=list)).length)return showNoItemsMessage();var serverId=items[0].ServerId;require(["addToList"]).then(function(responses){return(new responses[0]).show({items:items,serverId:serverId,type:"Collection"})})}(items),hideSelections();break;case"playlist":!function(items){for(var list=[],i=0,length=items.length;i<length;i++)itemHelper.supportsAddingToPlaylist(items[i])&&list.push(items[i]);if(!(items=filterItemsToOneServer(items=list)).length)return showNoItemsMessage();var serverId=items[0].ServerId;require(["addToList"]).then(function(responses){return(new responses[0]).show({items:items,serverId:serverId,type:"Playlist"})})}(items),hideSelections();break;case"delete":(function(items){var msg=globalize.translate("ConfirmDeleteItem"),title=globalize.translate("HeaderDeleteItem");return 1<items.length&&(msg=globalize.translate("ConfirmDeleteItems"),title=globalize.translate("HeaderDeleteItems")),msg+="\n\n"+globalize.translate("AreYouSureToContinue"),require(["confirm"]).then(function(responses){return responses[0](msg,title).then(function(){for(var promises=[],i=0,length=items.length;i<length;i++){var item=items[i];if(item.CanDelete){var apiClient=connectionManager.getApiClient(item);apiClient&&promises.push(apiClient.deleteItem(item.Id))}}return promises.length?Promise.all(promises).catch(function(){return alertText(globalize.translate("ErrorDeletingItem"))}):showNoItemsMessage()})})})(items).then(dispatchNeedsRefresh),hideSelections();break;case"groupvideos":!function(items,users){for(var list=[],i=0,length=items.length;i<length;i++){var item=items[i],user=users[item.ServerId];itemHelper.canManageMultiVersionGrouping(item,user)&&list.push(items[i])}var serverId=(items=filterItemsToOneServer(items=list))[0].ServerId;if(items.length<2)return alertText(globalize.translate("PleaseSelectTwoItems"));loading.show();var apiClient=connectionManager.getApiClient(serverId);apiClient.ajax({type:"POST",url:apiClient.getUrl("Videos/MergeVersions",{Ids:items.map(mapToId).join(",")})}).then(function(){loading.hide(),dispatchNeedsRefresh(),hideSelections()},function(){loading.hide(),hideSelections()})}(items,users);break;case"markplayed":!function(items){for(var any=!1,i=0,length=items.length;i<length;i++){var item=items[i];if(itemHelper.canMarkPlayed(item)){var apiClient=connectionManager.getApiClient(item);apiClient&&(apiClient.markPlayed(apiClient.getCurrentUserId(),item.Id),any=!0)}}any?Promise.resolve():showNoItemsMessage()}(items),hideSelections();break;case"markunplayed":!function(items){for(var any=!1,i=0,length=items.length;i<length;i++){var item=items[i];if(itemHelper.canMarkPlayed(item)){var apiClient=connectionManager.getApiClient(item);apiClient&&(apiClient.markUnplayed(apiClient.getCurrentUserId(),item.Id),any=!0)}}any?Promise.resolve():showNoItemsMessage()}(items),hideSelections();break;case"refresh":!function(items,users){for(var list=[],i=0,length=items.length;i<length;i++){var item=items[i],user=users[item.ServerId];itemHelper.canRefreshMetadata(item,user)&&list.push(items[i])}(items=filterItemsToOneServer(items=list)).length?(items[0].ServerId,require(["refreshDialog"]).then(function(responses){return new responses[0]({items:items}).show()})):showNoItemsMessage()}(items,users),hideSelections();break;case"sync":syncItems(items,users,!1),hideSelections();break;case"synclocal":syncItems(items,users,!0),hideSelections()}}})})})}function dispatchNeedsRefresh(){var i,length,elems=[],selectedElems=selectedElements;for(i=0,length=selectedElems.length;i<length;i++){var selectedElem=selectedElems[i],container=dom.parentWithAttribute(selectedElem,"is","emby-itemscontainer");container&&-1===elems.indexOf(container)&&elems.push(container)}for(i=0,length=elems.length;i<length;i++)elems[i].notifyRefreshNeeded(!0)}function mapToId(item){return item.Id}function showSelections(chkItemSelect,selected){chkItemSelect.classList.contains("chkCardSelect")||(chkItemSelect=chkItemSelect.querySelector(".chkCardSelect")),null==selected?selected=chkItemSelect.checked:chkItemSelect.checked=selected;var elemWithId=dom.parentWithAttribute(chkItemSelect,"data-id"),id=elemWithId.getAttribute("data-id"),serverId=elemWithId.getAttribute("data-serverid"),card=dom.parentWithClass(chkItemSelect,"card"),index=card.getAttribute("data-index");index=index?parseInt(index):-1;var container=dom.parentWithAttribute(chkItemSelect,"is","emby-itemscontainer"),item=0<=index?container.getItem(index):null;(null==item&&(item={Id:id,ServerId:serverId}),selected)?(card.querySelector(".cardBox").classList.add("item-multiselected"),selectedItems.filter(function(i){return i.Id===id&&i.ServerId===serverId}).length||(selectedItems.push(item),getSelectedItemsMap(serverId)[id]=!0,selectedElements.push(chkItemSelect))):(card.querySelector(".cardBox").classList.remove("item-multiselected"),selectedItems=selectedItems.filter(function(i){return i.Id!==id||i.ServerId!==serverId}),getSelectedItemsMap(serverId)[id]=null,selectedElements=selectedElements.filter(function(i){return i!==chkItemSelect}));if(selectedItems.length){container.classList.add("multi-select-active"),function(){var selectionCommandsPanel=currentSelectionCommandsPanel;if(!selectionCommandsPanel){(selectionCommandsPanel=document.createElement("div")).classList.add("selectionCommandsPanel"),document.body.appendChild(selectionCommandsPanel);'<button is="paper-icon-button-light" class="btnCloseSelectionPanel autoSize"><i class="md-icon">close</i></button>','<h1 class="itemSelectionCount"></h1>';'<button is="paper-icon-button-light" class="btnSelectionPanelOptions autoSize" style="margin-left:auto;"><i class="md-icon">&#xE5D3;</i></button>',(currentSelectionCommandsPanel=selectionCommandsPanel).innerHTML='<button is="paper-icon-button-light" class="btnCloseSelectionPanel autoSize"><i class="md-icon">close</i></button><h1 class="itemSelectionCount"></h1><button is="paper-icon-button-light" class="btnSelectionPanelOptions autoSize" style="margin-left:auto;"><i class="md-icon">&#xE5D3;</i></button>',selectionCommandsPanel.querySelector(".btnCloseSelectionPanel").addEventListener("click",hideSelections);var btnSelectionPanelOptions=selectionCommandsPanel.querySelector(".btnSelectionPanelOptions");dom.addEventListener(btnSelectionPanelOptions,"click",showMenuForSelectedItems,{passive:!0})}}();var itemSelectionCount=document.querySelector(".itemSelectionCount");itemSelectionCount&&(itemSelectionCount.innerHTML=selectedItems.length)}else hideSelections()}function MultiSelect(options){}return document.addEventListener("viewbeforehide",hideSelections),MultiSelect.prototype.showSelections=showSelections,MultiSelect.prototype.onContainerClick=function(e){if(selectedItems.length){var target=e.target,card=dom.parentWithClass(target,"card");if(card)if(!dom.parentWithClass(target,"chkCardSelectContainer")){var chkItemSelect=card.querySelector(".chkCardSelect");return showSelections(chkItemSelect,!chkItemSelect.checked),e.preventDefault(),e.stopPropagation(),!1}}},MultiSelect.isSelected=function(item){return getSelectedItemsMap(item.ServerId)[item.Id]},MultiSelect});