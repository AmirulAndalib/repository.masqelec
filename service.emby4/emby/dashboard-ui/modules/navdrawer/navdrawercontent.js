define(["events","layoutManager","connectionManager","globalize","dom","appRouter","cardBuilder","apphost","pluginManager"],function(events,layoutManager,connectionManager,globalize,dom,appRouter,cardBuilder,appHost,pluginManager){"use strict";var navDrawerElement,currentServerId,newInnerHtml,currentViewEvent,appHeader,currentDrawerType=0,enableLazyLoadingDrawerContents=!1;function getNavDrawerElement(){return navDrawerElement||(navDrawerElement=document.querySelector(".mainDrawer"),dom.addEventListener(navDrawerElement,"click",onNavDrawerClick,{passive:!0})),navDrawerElement}function onNavDrawerClick(e){var navMenuOption=dom.parentWithClass(e.target,"navMenuOption");if(navMenuOption){var onclick=navMenuOption.getAttribute("data-onclick");"logout"===onclick?appRouter.logout():"exit"===onclick?appHost.exit():"sleep"===onclick?appHost.sleep():"shutdown"===onclick?appHost.shutdown():"restart"===onclick&&appHost.restart()}}function addPluginPagesToMainMenu(links,pluginItems,section){for(var i=0,length=pluginItems.length;i<length;i++){var pluginItem=pluginItems[i];pluginManager.allowPluginPages(pluginItem.PluginId)&&pluginItem.EnableInMainMenu&&pluginItem.MenuSection===section&&links.push({name:pluginItem.DisplayName,icon:pluginItem.MenuIcon||"folder",href:pluginManager.getConfigurationPageUrl(pluginItem.Name),navMenuId:"/"+pluginManager.getConfigurationPageUrl(pluginItem.Name)})}}function getNavMenuLinkHtml(item,options){var menuHtml="",navMenuId=item.navMenuId;if(!navMenuId&&item.href){var routeInfo=appRouter.getRouteInfo(item.href);navMenuId=routeInfo&&routeInfo.navMenuId||item.href}navMenuId=navMenuId?' data-navmenuid="'+navMenuId+'"':"",item.onclick&&(navMenuId+=' data-onclick="'+item.onclick+'"');var itemClass="navMenuOption";return options.itemsClass&&(itemClass+=" navMenuOption-"+options.itemsClass),menuHtml+="<a"+navMenuId+' is="emby-linkbutton" class="'+itemClass+'" href="'+item.href+'" title="'+item.name+'">',item.icon&&(menuHtml+='<i class="md-icon navMenuOptionIcon">'+item.icon+"</i>"),menuHtml+='<span class="navMenuOptionText">',menuHtml+=item.name,menuHtml+="</span>",menuHtml+="</a>"}function getAdminMenuItems(apiClient,user){return appRouter.getRouteInfo(appRouter.getRouteUrl("manageserver"))&&user.Policy.IsAdministrator?apiClient.getJSON(apiClient.getUrl("web/configurationpages")+"?pageType=PluginConfiguration&EnableInMainMenu=true").then(function(items){return function(pluginItems,apiClient){var links=[{name:globalize.translate("Server")},{name:globalize.translate("Dashboard"),href:appRouter.getRouteUrl("manageserver"),icon:"dashboard"},{name:globalize.translate("Settings"),href:"/dashboardgeneral.html",icon:"settings"},{name:globalize.translate("Users"),href:"/users",icon:"people"},{name:"Emby Premiere",href:"/embypremiere",icon:"star"},{name:globalize.translate("Library"),href:"/librarysetup/library.html",icon:"folder"},{name:globalize.translate("Network"),icon:"wifi",href:"/network"},{name:globalize.translate("Transcoding"),icon:"transform",href:"/transcoding"}];return apiClient.isMinServerVersion("4.3.0.7")&&links.push({name:globalize.translate("Conversions"),icon:"transform",href:"/syncactivity.html?mode=convert"}),addPluginPagesToMainMenu(links,pluginItems,"server"),links.push({divider:!0,name:globalize.translate("Devices")}),links.push({name:globalize.translate("Devices"),href:"/devices",icon:"devices"}),links.push({name:globalize.translate("Downloads"),icon:"cloud_download",href:"/syncactivity.html"}),links.push({name:globalize.translate("HeaderCameraUpload"),href:"/devices/cameraupload.html",icon:"photo_camera"}),addPluginPagesToMainMenu(links,pluginItems,"devices"),links.push({divider:!0,name:globalize.translate("LiveTV")}),links.push({name:globalize.translate("LiveTV"),href:"/livetvsetup/livetvstatus.html",icon:"&#xE639;"}),links.push({name:"DVR",href:"/livetvsetup/livetvsettings.html",icon:"dvr"}),links.push({divider:!0,name:globalize.translate("Advanced")}),links.push({name:globalize.translate("Logs"),href:"/logs",icon:"folder_open"}),links.push({name:globalize.translate("Notifications"),icon:"notifications",href:"/notificationsettings.html"}),links.push({name:globalize.translate("Plugins"),icon:"add_shopping_cart",href:"/plugins/plugins.html"}),links.push({name:globalize.translate("HeaderScheduledTasks"),href:"/scheduledtasks",icon:"schedule"}),links.push({name:globalize.translate("HeaderApiKeys"),href:"/apikeys",icon:"vpn_key"}),links.push({name:globalize.translate("MetadataManager"),href:"/metadatamanager",icon:"edit"}),addPluginPagesToMainMenu(links,pluginItems),links}(items,apiClient)},function(err){return[]}):Promise.resolve([])}function sortRoutes(a,b){var aOrder=null==a.order?1e3:a.order,bOrder=null==b.order?1e3:b.order;if(bOrder<aOrder)return 1;if(aOrder<bOrder)return-1;var aName=a.title;aName=aName&&globalize.translate(aName);var bName=b.title;return(bName=bName&&globalize.translate(bName))<aName?1:aName<bName?-1:0}function getUserSetingsRoutes(user){var routes=appRouter.getRoutes().filter(function(r){return function(route,user){return"settings"===route.type&&("user"===route.settingsType&&appRouter.validateUserAccessToRoute(route,user))}(r,user)});return routes=routes.sort(sortRoutes)}function mapRouteToMenuItem(route,user){var path=route.path;return path&&"settings"===route.type&&"user"===route.settingsType&&(path+="?userId="+user.Id,path+="&serverId="+user.ServerId),{name:globalize.translate(route.title),href:path,icon:route.icon}}function getAppSettingsMenuItems(options){var i,length,items=[],user=(options.apiClient,options.user),routes=getUserSetingsRoutes(user);if(routes.length)for(items.push({name:user.Name}),i=0,length=routes.length;i<length;i++)items.push(mapRouteToMenuItem(routes[i],user));options.selectServer&&appHost.supports("multiserver")&&items.push({name:globalize.translate("HeaderSelectServer"),href:appRouter.getRouteUrl("selectserver"),icon:"router"}),options.signOut&&!user.EnableAutoLogin&&items.push({name:globalize.translate("HeaderSignOut"),href:"#",icon:"&#xE879;",onclick:"logout"}),routes=function(){var routes=appRouter.getRoutes().filter(function(r){return"settings"===r.type&&"user"!==r.settingsType});return routes=routes.sort(sortRoutes)}();var supportsExit=appHost.supports("exit")&&layoutManager.tv;if(routes.length||supportsExit)for(items.push({name:appHost.appName()}),i=0,length=routes.length;i<length;i++)items.push(mapRouteToMenuItem(routes[i],user));return supportsExit&&items.push({name:globalize.translate("Exit"),href:"#",icon:"&#xE879;",onclick:"exit"}),items=items.concat(function(){var items=[];appHost.supports("sleep")&&items.push({name:globalize.translate("Sleep"),href:"#",icon:"&#xE426;",onclick:"sleep"});appHost.supports("shutdown")&&items.push({name:globalize.translate("Shutdown"),href:"#",icon:"&#xE8AC;",onclick:"shutdown"});appHost.supports("restart")&&items.push({name:globalize.translate("Restart"),href:"#",icon:"&#xE5D5;",onclick:"restart"});items.length&&items.unshift({name:appHost.deviceName()});return items}()),Promise.resolve(items)}function getItemsHtml(items,options){var i,length,item,menuHtml="";for(i=0,length=items.length;i<length;i++)if((item=items[i]).href)menuHtml+=getNavMenuLinkHtml(item,options);else if(item.name){var headerClass="navMenuHeader secondaryText";options.itemsClass&&(headerClass+=" navMenuHeader-"+options.itemsClass),menuHtml+='<h3 class="'+headerClass+'">',item.imageUrl&&(menuHtml+='<img src="'+item.imageUrl+'" class="navMenuHeaderImage" />'),menuHtml+=item.name,menuHtml+="</h3>"}return menuHtml}function getSettingsDrawerHtml(options){return function(options){var apiClient=options.apiClient,user=options.user;return Promise.all([getAppSettingsMenuItems(options),getAdminMenuItems(apiClient,user)]).then(function(responses){var items=responses[0];return items=items.concat(responses[1])})}(options).then(function(items){return getItemsHtml(items,options)})}function getLibraryDrawerHtml(apiClient){return apiClient.getCurrentUser().then(function(user){return function(apiClient){return apiClient.getUserViews({},apiClient.getCurrentUserId()).then(function(result){for(var items=result.Items,list=[],i=0,length=items.length;i<length;i++){var view=items[i];if(list.push(view),"livetv"===view.CollectionType){var guideView=Object.assign({},view);guideView.Name=globalize.translate("Guide"),guideView.ImageTags={},guideView.icon="dvr",guideView.url=appRouter.getRouteUrl("livetv",{section:"guide",serverId:apiClient.serverId()}),list.push(guideView)}}return list})}(apiClient).then(function(result){var items=result,menuItems=[];user.Policy.EnableContentDownloading&&appHost.supports("sync")&&(menuItems.push({name:globalize.translate("Downloads")}),menuItems.push({name:globalize.translate("Downloads"),href:appRouter.getRouteUrl("downloads"),icon:"&#xE2C7;"}),menuItems.push({name:globalize.translate("Manage"),href:appRouter.getRouteUrl("managedownloads"),icon:"&#xE3C9;"})),menuItems.push({name:globalize.translate("HeaderMyMedia")});for(var iconOptions={defaultIcon:"folder"},i=0,length=items.length;i<length;i++){var item=items[i],url=appRouter.getRouteUrl(item,{context:item.CollectionType});menuItems.push({name:item.Name,href:url,icon:item.icon||cardBuilder.getDefaultIcon(item,iconOptions)})}return user.Policy.IsAdministrator&&appRouter.getRouteInfo(appRouter.getRouteUrl("manageserver"))&&(menuItems.push({name:globalize.translate("Admin")}),menuItems.push({name:globalize.translate("ManageEmbyServer"),href:appRouter.getRouteUrl("manageserver"),icon:"&#xE8B8;"}),menuItems.push({name:globalize.translate("MetadataManager"),href:"/metadatamanager",icon:"&#xE2C7;"})),menuItems.push({name:globalize.translate("Settings"),href:appRouter.getRouteUrl("settings",{serverId:apiClient.serverId()}),icon:"&#xE8B8;"}),appHost.supports("multiserver")&&menuItems.push({name:globalize.translate("HeaderSelectServer"),href:appRouter.getRouteUrl("selectserver"),icon:"router"}),user.EnableAutoLogin||menuItems.push({name:globalize.translate("HeaderSignOut"),href:"#",icon:"&#xE879;",onclick:"logout"}),getItemsHtml(menuItems,{})})})}function getDrawerHtml(type){var apiClient=currentServerId?connectionManager.getApiClient(currentServerId):connectionManager.currentApiClient();return 1===type&&currentServerId?getLibraryDrawerHtml(apiClient):2===type?function(apiClient){return apiClient.getCurrentUser().then(function(user){return getSettingsDrawerHtml({apiClient:apiClient,user:user})})}(apiClient):Promise.resolve("")}function onSetInnerHtmlCallback(){var html=newInnerHtml;if(null!=html){newInnerHtml=null;var elem=getNavDrawerElement();elem.innerHTML=html,elem.scrollTop=0,html&&currentViewEvent&&updateSelectedItem(currentViewEvent)}}function updateSelectedItem(e){var currentNavMenuId=e.detail.navMenuId;currentNavMenuId=currentNavMenuId||(currentNavMenuId=window.location.href.toString()).substring(currentNavMenuId.indexOf("#!")+2);var navDrawerElement=getNavDrawerElement(),newSelectedOption=currentNavMenuId?navDrawerElement.querySelector('.navMenuOption[data-navmenuid="'+currentNavMenuId+'"]'):null;if(!newSelectedOption||!newSelectedOption.classList.contains("navMenuOption-selected")){var currentSelectedOption=navDrawerElement.querySelector(".navMenuOption-selected");currentSelectedOption&&currentSelectedOption.classList.remove("navMenuOption-selected"),newSelectedOption&&(newSelectedOption.classList.add("navMenuOption-selected"),e.detail.settingsTheme&&function(newSelectedOption){var link=newSelectedOption.querySelector("span")||newSelectedOption,title=(link.innerText||link.textContent).trim();appHeader?appHeader.setTitle(title):function(title){require(["appHeader"]).then(function(responses){(appHeader=responses[0]).setTitle(title)})}(title)}(newSelectedOption))}}function onViewShowInternal(e,loadContent){var drawerType=function(e){var detail=e.detail;return currentServerId&&!1!==detail.drawer?detail.settingsTheme?2:1:0}(e);drawerType!==currentDrawerType?loadContent?function(e,type){getDrawerHtml(currentDrawerType=type).then(function(itemsHtml){newInnerHtml=itemsHtml,requestAnimationFrame(onSetInnerHtmlCallback)})}(0,drawerType):(newInnerHtml="",requestAnimationFrame(onSetInnerHtmlCallback)):currentDrawerType&&loadContent&&updateSelectedItem(e)}return events.on(connectionManager,"localusersignedin",function(e,serverId,userId){currentServerId=serverId,currentDrawerType=0}),events.on(connectionManager,"localusersignedout",function(){currentServerId=null}),getNavDrawerElement().addEventListener("drawer-opening",function(){enableLazyLoadingDrawerContents&&onViewShowInternal(currentViewEvent,!0)}),{onViewShow:function(e){onViewShowInternal(currentViewEvent=e,!(enableLazyLoadingDrawerContents=!e.detail.drawerInline&&layoutManager.tv))},getSettingsDrawerHtml:getSettingsDrawerHtml,onNavDrawerClick:onNavDrawerClick}});