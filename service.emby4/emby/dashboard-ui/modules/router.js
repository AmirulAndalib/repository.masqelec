define(["loading","globalize","events","viewManager","layoutManager","skinManager","backdrop","browser","pageJs","appSettings","apphost","connectionManager","userSettings","itemHelper","pluginManager"],function(loading,globalize,events,viewManager,layoutManager,skinManager,backdrop,browser,page,appSettings,appHost,connectionManager,userSettings,itemHelper,pluginManager){"use strict";var appRouter={showLocalLogin:function(serverId,manualLogin){return show("/startup/"+(manualLogin?"manuallogin":"login")+".html?serverId="+serverId)},showSelectServer:function(){return show(getRouteUrl("selectserver"))},showWelcome:function(){return appHost.supports("multiserver")?show("/startup/welcome.html"):show("/startup/login.html?serverId="+connectionManager.currentApiClient().serverId())},showConnectLogin:function(){return show(getRouteUrl("connectlogin"))},showSettings:function(){return show(getRouteUrl("settings",{serverId:connectionManager.currentApiClient().serverId()}))},showUserMenu:function(){return appRouter.showSettings()},showSearch:function(){return show(getRouteUrl("search"))},showGuide:function(){return show(appRouter.getRouteUrl("livetv",{serverId:connectionManager.currentApiClient().serverId(),section:"guide"}))},showLiveTV:function(){return show(appRouter.getRouteUrl("livetv",{serverId:connectionManager.currentApiClient().serverId()}))},showRecordedTV:function(){return show(appRouter.getRouteUrl("recordedtv",{serverId:connectionManager.currentApiClient().serverId()}))},showFavorites:function(){return show(getHomeRoute()+"&tab=1")},showNowPlaying:function(){return show("/videoosd/videoosd.html")}};function showLocalLoginFromApiClient(apiClient){return apiClient.getPublicUsers().then(function(users){return users.length?appRouter.showLocalLogin(apiClient.serverId()):appRouter.showLocalLogin(apiClient.serverId(),!0)})}function beginConnectionWizard(){return backdrop.clear(),loading.show(),appHost.supports("multiserver")?connectionManager.connect({enableAutoLogin:appSettings.enableAutoLogin()}).then(function(result){return handleConnectionResult(result,!1,!0)}):showLocalLoginFromApiClient(connectionManager.currentApiClient())}function handleConnectionResult(result,allowServerUpdateNeedAlert,useWelcomeForConnectSignIn){switch(result.State){case"SignedIn":loading.hide(),skinManager.loadUserSkin();break;case"ServerSignIn":showLocalLoginFromApiClient(result.ApiClient);break;case"ServerSelection":appHost.supports("multiserver")?appRouter.showSelectServer():showLocalLoginFromApiClient(connectionManager.currentApiClient());break;case"ConnectSignIn":!0===useWelcomeForConnectSignIn?appRouter.showWelcome():appRouter.showConnectLogin();break;case"ServerUpdateNeeded":!1===allowServerUpdateNeedAlert?appRouter.showSelectServer():(loading.hide(),require(["alert"],function(alert){alert(globalize.translate("ServerUpdateNeeded",'<a href="https://emby.media">https://emby.media</a>')).then(function(){show("/startup/selectserver.html")})}));break;case"Unavailable":loading.hide(),showAlert({text:globalize.translate("MessageUnableToConnectToServer"),title:globalize.translate("HeaderConnectionFailure")})}}var currentViewLoadRequest,currentRouteInfo,isDummyBackToHome,firstConnectionResult,loadedTranslations={};function loadPluginTranslations(pageName){if(loadedTranslations[pageName])return Promise.resolve();loadedTranslations[pageName]=!0;var apiClient=connectionManager.currentApiClient();return apiClient.getJSON(apiClient.getUrl("web/configurationpages",{Name:pageName})).then(function(configPages){if(configPages.length)return function(apiClient,configPage){var languages=configPage.Translations;if(!languages||!languages.length)return Promise.resolve();var translations=(languages||[]).map(function(i){return{lang:i,path:apiClient.getUrl("web/strings",{PluginId:configPage.PluginId,Locale:i})}});return globalize.loadStrings({name:"plugin-"+configPage.PluginId,translations:translations})}(apiClient,configPages[0])})}function loadContentUrl(ctx,route,request){var url;-1===(url=route.contentPath&&"function"==typeof route.contentPath?route.contentPath(ctx.querystring):route.contentPath||route.path).indexOf("://")&&(0!==url.indexOf("/")&&(url="/"+url),url=baseUrl()+url),ctx.querystring&&route.enableContentQueryString&&(url+="?"+ctx.querystring);var promises=[require(["text!"+url])];(getRouteInfo("/configurationpage")||getRouteInfo("/configurationpageext"))&&(request.isPluginPage=-1!==request.url.toLowerCase().indexOf("/configurationpage"),request.isPluginPage&&promises.push(loadPluginTranslations(function(name,url){name=name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var regex=new RegExp("[\\?&]"+name+"=([^&#]*)","i"),search=window.location.search;if(!search){var index=window.location.href.indexOf("?");-1!==index&&(search=window.location.href.substring(index))}var results=regex.exec(url||search);return null==results?"":decodeURIComponent(results[1].replace(/\+/g," "))}("name",request.url)))),Promise.all(promises).then(function(responses){var html=responses[0][0];!function(ctx,route,html,request){request.view=globalize.translateDocument(html,route.dictionary),viewManager.loadView(request),currentRouteInfo={route:route,path:ctx.path},ctx.handled=!0}(ctx,route,html,request)})}function handleRoute(ctx,route){!function(ctx,route,callback){var firstResult=firstConnectionResult;if(firstResult&&(firstConnectionResult=null,"SignedIn"!==firstResult.State&&!route.anonymous))return handleConnectionResult(firstResult,!1,!0);var apiClient=connectionManager.currentApiClient(),pathname=ctx.pathname.toLowerCase();console.log("appRouter - processing path request "+pathname);var isCurrentRouteStartup=!currentRouteInfo||currentRouteInfo.route.startup,shouldExitApp=ctx.isBack&&route.isDefaultRoute&&isCurrentRouteStartup;if(!(shouldExitApp||apiClient&&apiClient.isLoggedIn()||route.anonymous))return console.log("appRouter - route does not allow anonymous access, redirecting to login"),beginConnectionWizard();if(shouldExitApp)return appHost.supports("exit")&&appHost.exit();if(apiClient&&apiClient.isLoggedIn()){if(console.log("appRouter - user is authenticated"),ctx.isBack&&(route.isDefaultRoute||route.startup)&&!isCurrentRouteStartup)return function(){if(appHost.supports("exit")&&!appHost.supports("exitmenu"))return appHost.exit();if(isDummyBackToHome=!0,skinManager.loadUserSkin(),!layoutManager.tv&&!appHost.supports("exit"))return;!function(showHome){require(["backMenu"]).then(function(responses){return responses[0]({showHome:showHome})})}(!1)}();if(route.isDefaultRoute)return console.log("appRouter - loading skin home page"),function(ctx){require(["queryString"],function(queryString){var params=queryString.parse(ctx.querystring);skinManager.loadUserSkin({start:params.start})})}(ctx);if(route.roles)return function(apiClient,route){return route.roles?apiClient.getCurrentUser().then(function(user){return validateUserAccessToRoute(route,user)}):Promise.resolve()}(apiClient,route).then(function(){callback()},beginConnectionWizard)}console.log("appRouter - proceeding to "+pathname),callback()}(ctx,route,function(){!function(ctx,route){function onInitComplete(controllerFactory){!function(ctx,route,controllerFactory){if(isDummyBackToHome&&"home"===route.type)return isDummyBackToHome=!1;!function(){var currentRequest=currentViewLoadRequest;currentRequest&&(currentRequest.cancel=!0)}();var isBackNav=ctx.isBack,currentRequest=Object.assign({},route);if(currentRequest.url=baseUrl()+ctx.path,currentRequest.controllerFactory=controllerFactory,currentRequest.state=ctx.state,currentRequest.isBack=isBackNav,currentViewLoadRequest=currentRequest,!isBackNav)return loadContentUrl(ctx,route,currentRequest);viewManager.tryRestoreView(currentRequest,function(){currentRouteInfo={route:route,path:ctx.path}}).catch(function(result){result&&result.cancelled||loadContentUrl(ctx,route,currentRequest)})}(ctx,route,controllerFactory)}route.controller?require([route.controller],onInitComplete):onInitComplete()}(ctx,route)})}function onBeforeExit(e){browser.web0s&&page.restorePreviousState()}function getMaxBandwidth(){var connection=navigator.connection;if(connection){var downlink=connection.downlink;if(downlink&&0<downlink&&downlink<Number.POSITIVE_INFINITY)return downlink*=1e6,downlink*=.7,downlink=parseInt(downlink);if((downlink=connection.downlinkMax)&&0<downlink&&downlink<Number.POSITIVE_INFINITY)return downlink*=1e6,downlink*=.7,downlink=parseInt(downlink)}return browser.tv||browser.ps4||browser.xboxOne||browser.edgeUwp||browser.chromecast?null:15e5}function onApiClientCreated(e,newApiClient){newApiClient.getMaxBandwidth=getMaxBandwidth}function initApiClient(apiClient){onApiClientCreated(0,apiClient)}function onAppResume(){connectionManager.onAppResume()}function validateUserAccessToRoute(route,user){var roles=(route.roles||"").split(",");return!(-1!==roles.indexOf("admin")&&!user.Policy.IsAdministrator)&&!(-1!==roles.indexOf("EnableUserPreferenceAccess")&&!user.Policy.EnableUserPreferenceAccess)}function getRequestFile(){var path=self.location.pathname||"",index=path.lastIndexOf("/");return(path=-1!==index?path.substring(index):"/"+path)&&"/"!==path||(path="/index.html"),path}function endsWith(str,srch){return str.lastIndexOf(srch)===srch.length-1}appHost.supports("multiserver")&&navigator.connection&&navigator.connection.addEventListener&&navigator.connection.addEventListener("change",function(){connectionManager.onNetworkChanged()});var resolveOnNextShow,backdropContainer,backgroundContainer,baseRoute=self.location.href.split("?")[0].replace(getRequestFile(),"");function baseUrl(){return baseRoute}function show(path,options){0!==path.indexOf("/")&&-1===path.indexOf("://")&&(path="/"+path);var baseRoute=baseUrl();return path=path.replace(baseRoute,""),currentRouteInfo&&currentRouteInfo.path===path&&"home"!==currentRouteInfo.route.type?(loading.hide(),Promise.resolve()):new Promise(function(resolve,reject){resolveOnNextShow=resolve,page.show(path,options)})}function current(){return currentRouteInfo?currentRouteInfo.route:null}function getHomeRoute(){return layoutManager.tv&&"horizontal"===userSettings.get("tvhome")&&!browser.netcast?"/home_horiz/home.html":"/home"}function getRouteInfo(url){return page.getRoute(url)}function getRouteUrl(item,options){if(item.url)return item.url;var url,context=(options=options||{})?options.context:null,id=item.Id||item.ItemId,serverId=item.ServerId||options.serverId;if("home"===item)return getHomeRoute();if("search"===item)return"/search";if("connectlogin"===item)return"/startup/connectlogin.html";if("selectserver"===item)return"/startup/selectserver.html";if("settings"===item)return serverId?"/settings?serverId="+serverId:"/settings";if("wizard"===item)return"/wizardstart.html";if("downloads"===item)return"/list/list.html?parentId=downloads";if("downloadsettings"===item)return"/settings/download.html";if("premiere"===item)return"/embypremiere";if("managedownloads"===item)return"/settings/managedownloads.html";if("manageserver"===item)return"/dashboard";if("recordedtv"===item)return"/livetv?tab=3&serverId="+serverId;if("nextup"===item)return"/list/list.html?type=nextup&serverId="+serverId;if("PluginCatalog"===item)return"/plugins/plugincatalog.html";if("livetv"===item||"livetv"===item.CollectionType)return"programs"===options.section?"/livetv?tab=0&serverId="+serverId:"guide"===options.section?"/livetv?tab=1&serverId="+serverId:"movies"===options.section?"/list/list.html?type=Program&IsMovie=true&serverId="+serverId:"shows"===options.section?"/list/list.html?type=Program&IsSeries=true&IsMovie=false&IsNews=false&serverId="+serverId:"sports"===options.section?"/list/list.html?type=Program&IsSports=true&serverId="+serverId:"kids"===options.section?"/list/list.html?type=Program&IsKids=true&serverId="+serverId:"news"===options.section?"/list/list.html?type=Program&IsNews=true&serverId="+serverId:"onnow"===options.section?"/list/list.html?type=Program&IsAiring=true&serverId="+serverId:"dvrschedule"===options.section?"/livetv?tab=4&serverId="+serverId:"/livetv?serverId="+serverId;if("list"===item)return url="/list/list.html?serverId="+serverId+"&type="+options.itemTypes,options.isFavorite&&(url+="&IsFavorite=true"),options.artistId&&(url+="&artistId="+options.artistId),options.albumArtistId&&(url+="&albumArtistId="+options.albumArtistId),url;var itemType=item.Type||(options?options.itemType:null);if("EmbyConnect"===itemType)return getRouteUrl("connectlogin");if("Downloads"===itemType)return getRouteUrl("downloads");if("SelectServer"===itemType)return getRouteUrl("selectserver");if("ForgotPassword"===itemType)return"/startup/forgotpassword.html?serverId="+serverId;if("ManualLogin"===itemType)return url="/startup/manuallogin.html?serverId="+serverId,item.Username&&(url+="&user="+encodeURIComponent(item.Username)),url;if("SeriesTimer"===itemType)return"/item?seriesTimerId="+id+"&serverId="+serverId;if("Device"===itemType)return"/devices/device.html?id="+id;if("AddServer"===itemType)return"/startup/manualserver.html";if("Plugin"===itemType)return pluginManager.allowPluginPages(item.Id)?"/"+item.ConfigPageUrl:null;if("User"===itemType)return"/useredit.html?userId="+id;if("GameGenre"===itemType)return url="/list/list.html?gameGenreId="+id+"&serverId="+serverId,options.parentId&&(url+="&parentId="+options.parentId),url;if("MusicGenre"===itemType)return url="/list/list.html?musicGenreId="+id+"&serverId="+serverId,options.parentId&&(url+="&parentId="+options.parentId),url;if("Tag"===itemType||"Studio"===itemType||"Genre"===itemType)return url="/list/list.html?"+item.Type.toLowerCase()+"Id="+id+"&serverId="+serverId,"livetv"===context&&(url+="&type=Program"),options.parentId&&(url+="&parentId="+options.parentId),options.itemTypes&&(url+="&type="+options.itemTypes),url;if("folders"!==context&&"GameSystem"===item.Type)return url="/list/list.html?type=Game&serverId="+serverId,url+="&parentId="+id;if("folders"!==context&&!itemHelper.isLocalItem(item)){if("movies"===item.CollectionType)return url="/movies?serverId="+serverId+"&parentId="+id,"latest"===options.section&&(url+="&tab=1"),url;if("games"===item.CollectionType)return url="/games?serverId="+serverId+"&parentId="+id;if("musicvideos"===item.CollectionType)return url="/musicvideos?serverId="+serverId+"&parentId="+id,"latest"===options.section&&(url+="&tab=1"),url;if("homevideos"===item.CollectionType)return url="/homevideos?serverId="+serverId+"&parentId="+id,"latest"===options.section&&(url+="&tab=1"),url;if("tvshows"===item.CollectionType)return url="/tv?serverId="+serverId+"&parentId="+id,"latest"===options.section&&(url+="&tab=1"),url;if("music"===item.CollectionType||"audiobooks"===item.CollectionType)return url="/music?serverId="+serverId+"&parentId="+id}return"Playlist"===itemType||"TvChannel"===itemType||"Program"===itemType||"BoxSet"===itemType||"MusicAlbum"===itemType||"MusicGenre"===itemType||"Person"===itemType||"Recording"===itemType||"MusicArtist"===itemType?"/item?id="+id+"&serverId="+serverId:"Series"===itemType||"Season"===itemType||"Episode"===itemType?"/item?id="+id+(context?"&context="+context:"")+"&serverId="+serverId:item.IsFolder?id?"/list/list.html?parentId="+id+"&serverId="+serverId:"#":"/item?id="+id+"&serverId="+serverId}function showAlert(text){return require(["alert"]).then(function(responses){return responses[0](text)})}function showItem(item,serverId,options){if("string"==typeof item){var apiClient=serverId?connectionManager.getApiClient(serverId):connectionManager.currentApiClient();return apiClient.getItem(apiClient.getCurrentUserId(),item).then(function(item){return appRouter.showItem(item,options)})}if("Plugin"===item.Type){if(!item.ConfigPageUrl)return showAlert(globalize.translate("NoPluginConfigurationMessage"));if(!pluginManager.allowPluginPages(item.Id))return showAlert(globalize.translate("MessagePluginConfigurationRequiresLocalAccess"))}else if("Server"===item.Type)return Promise.reject();return 2===arguments.length&&(options=serverId),show(appRouter.getRouteUrl(item,options),{item:item})}function addRoute(path,newRoute){path&&newRoute?page(path,newRoute,handleRoute):function(newRoute){var baseRoute=baseUrl(),path=newRoute.path;path=path.replace(baseRoute,""),console.log("Defining route: "+path),addRoute(path,newRoute)}(path)}return endsWith(baseRoute=baseRoute.split("#")[0],"/")&&!endsWith(baseRoute,"://")&&(baseRoute=baseRoute.substring(0,baseRoute.length-1)),document.addEventListener("viewshow",function(){var resolve=resolveOnNextShow;resolve&&(resolveOnNextShow=null,resolve())}),function(){var baseRoute=self.location.pathname.replace(getRequestFile(),"");baseRoute.lastIndexOf("/")===baseRoute.length-1&&(baseRoute=baseRoute.substring(0,baseRoute.length-1)),console.log("Setting page base to "+baseRoute),page.base(baseRoute)}(),appRouter.addRoute=addRoute,appRouter.param=function(name,url){name=name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var results=new RegExp("[\\?&]"+name+"=([^&#]*)","i").exec(url||function(){var currentPath=currentRouteInfo&&currentRouteInfo.path||"",index=currentPath.indexOf("?"),search="";return-1!==index&&(search=currentPath.substring(index)),search||""}());return null==results?"":decodeURIComponent(results[1].replace(/\+/g," "))},appRouter.back=function(){page.back()},appRouter.show=show,appRouter.start=function(options){return loading.show(),connectionManager.getApiClients().forEach(initApiClient),events.on(connectionManager,"apiclientcreated",onApiClientCreated),events.on(appHost,"beforeexit",onBeforeExit),events.on(appHost,"resume",onAppResume),connectionManager.connect({enableAutoLogin:appSettings.enableAutoLogin()}).then(function(result){firstConnectionResult=result,loading.hide(),page({click:!1!==(options=options||{}).click,hashbang:!1!==options.hashbang})})},appRouter.baseUrl=baseUrl,appRouter.canGoBack=function(){var curr=current();return!!curr&&("home"!==curr.type&&page.canGoBack())},appRouter.current=current,appRouter.beginConnectionWizard=beginConnectionWizard,appRouter.goHome=function(){return show(getHomeRoute())},appRouter.showItem=showItem,appRouter.setTitle=function(title){require(["appHeader"],function(appHeader){appHeader.setTitle(title)})},appRouter.setTransparency=function(level){backdropContainer=backdropContainer||document.querySelector(".backdropContainer"),backgroundContainer=backgroundContainer||document.querySelector(".backgroundContainer"),"full"===level||2===level?(backdrop.clear(!0),document.documentElement.classList.add("transparentDocument"),backgroundContainer.classList.add("backgroundContainer-transparent"),backdropContainer.classList.add("hide")):"backdrop"===level||1===level?(backdrop.externalBackdrop(!0),document.documentElement.classList.add("transparentDocument"),backgroundContainer.classList.add("backgroundContainer-transparent"),backdropContainer.classList.add("hide")):(backdrop.externalBackdrop(!1),document.documentElement.classList.remove("transparentDocument"),backgroundContainer.classList.remove("backgroundContainer-transparent"),backdropContainer.classList.remove("hide"))},appRouter.getRoutes=function(){return page.getRoutes()},appRouter.getRouteUrl=getRouteUrl,appRouter.getRouteInfo=getRouteInfo,appRouter.pushState=function(state,title,url){state.navigate=!1,page.pushState(state,title,url)},appRouter.enableNativeHistory=function(){return!browser.orsay},appRouter.showVideoOsd=function(options){var url="/videoosd/videoosd.html";return options&&options.controls&&(url+="?controls=true"),show(url)},appRouter.handleAnchorClick=page.handleAnchorClick,appRouter.TransparencyLevel={None:0,Backdrop:1,Full:2},appRouter.invokeShortcut=function(id){return 0===id.indexOf("library-")?showItem((id=(id=id.replace("library-","")).split("_"))[0],id[1]):0===id.indexOf("item-")?showItem((id=(id=id.replace("item-","")).split("_"))[0],id[1]):(id=id.split("_"),show(appRouter.getRouteUrl(id[0],{serverId:id[1]})))},appRouter.logout=function(){require(["playbackManager"],function(playbackManager){loading.show(),playbackManager.stop(),connectionManager.logout().then(beginConnectionWizard)})},appRouter.handleConnectionResult=handleConnectionResult,appRouter.validateUserAccessToRoute=validateUserAccessToRoute,appRouter});