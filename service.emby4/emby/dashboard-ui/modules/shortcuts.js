define(["appSettings","layoutManager","playbackManager","inputManager","connectionManager","appRouter","globalize","loading","dom","recordingHelper"],function(appSettings,layoutManager,playbackManager,inputManager,connectionManager,appRouter,globalize,loading,dom,recordingHelper){"use strict";function playAllFromHere(card,itemId,serverId,queue){var startIndex=parseInt(card.getAttribute("data-index")),itemsContainer=dom.parentWithClass(card,"itemsContainer");if(itemsContainer&&itemsContainer.fetchData){var fetchAll=!queue&&startIndex<1e3,queryOptions=fetchAll?{Limit:1e3}:{StartIndex:startIndex,Limit:1e3};return itemsContainer.fetchData(queryOptions).then(function(result){return queue?playbackManager.queue({items:result.Items||result}):playbackManager.play({items:result.Items||result,startIndex:fetchAll?startIndex:null})})}for(var parent=card.parentNode,className=card.classList.length?"."+card.classList[0]:"",cards=parent.querySelectorAll(className+"[data-id]"),ids=[],foundCard=!1,i=0,length=cards.length;i<length;i++)cards[i]===card&&(foundCard=!0,startIndex=i),!foundCard&&queue||ids.push(cards[i].getAttribute("data-id"));if(ids.length)return queue?playbackManager.queue({ids:ids,serverId:serverId}):playbackManager.play({ids:ids,serverId:serverId,startIndex:startIndex})}function getItemFromElement(element){var index=element.getAttribute("data-index");if(index){var elem=dom.parentWithClass(element,"itemsContainer").getItem(parseInt(index));if(elem)return elem}return function(card){var item={Type:card.getAttribute("data-type"),Id:card.getAttribute("data-id"),ServerId:card.getAttribute("data-serverid"),IsFolder:"true"===card.getAttribute("data-isfolder")},timerId=card.getAttribute("data-timerid");timerId&&(item.TimerId=timerId);var channelId=card.getAttribute("data-channelid");channelId&&(item.ChannelId=channelId);var mediaType=card.getAttribute("data-mediatype");mediaType&&(item.MediaType=mediaType);var seriesId=card.getAttribute("data-seriesid");return seriesId&&(item.SeriesId=seriesId),item}(element)}function getItem(button){var type=(button=dom.parentWithAttribute(button,"data-type")).getAttribute("data-type");if("Plugin"===type)return Promise.resolve(getItemFromElement(button));if("Device"===type)return Promise.resolve(getItemFromElement(button));if("Server"===type)return Promise.resolve(getItemFromElement(button));if("ActivityLogEntry"===type)return Promise.resolve(getItemFromElement(button));var id=button.getAttribute("data-id");if(!id)return Promise.resolve(getItemFromElement(button));var serverId=button.getAttribute("data-serverid"),apiClient=connectionManager.getApiClient(serverId);return"VirtualFolder"===type?function(apiClient,id){return apiClient.getVirtualFolders().then(function(items){return items.filter(function(u){return u.ItemId===id})[0]})}(apiClient,id):"User"===type?apiClient.getUser(id):"Timer"===type?apiClient.getLiveTvTimer(id):"SeriesTimer"===type?apiClient.getLiveTvSeriesTimer(id):apiClient.getItem(apiClient.getCurrentUserId(),id)}function notifyRefreshNeeded(childElement,itemsContainer){(itemsContainer=itemsContainer||dom.parentWithAttribute(childElement,"is","emby-itemscontainer"))&&itemsContainer.notifyRefreshNeeded(!0)}function showContextMenu(card,options){return getItem(card).then(function(item){var playlistId=card.getAttribute("data-playlistid"),collectionId=card.getAttribute("data-collectionid");if(playlistId){var elem=dom.parentWithAttribute(card,"data-playlistitemid");item.PlaylistItemId=elem?elem.getAttribute("data-playlistitemid"):null}return require(["itemContextMenu"]).then(function(responses){return function(item){var serverId=item.ServerId;if(!serverId)return Promise.resolve(null);var apiClient=connectionManager.getApiClient(serverId);return apiClient.getCurrentUserId()?apiClient.getCurrentUser():Promise.resolve(null)}(item).then(function(user){return responses[0].show(Object.assign({item:item,play:!0,queue:!0,playAllFromHere:!item.IsFolder,queueAllFromHere:!item.IsFolder,playlistId:playlistId,collectionId:collectionId,user:user,multiSelect:!!card.querySelector(".chkCardSelectContainer")},options||{})).then(function(result){var itemsContainer=options.itemsContainer||dom.parentWithClass(card,"itemsContainer");if("playallfromhere"===result.command||"queueallfromhere"===result.command)return executeAction(card,options.positionTo,result.command);"addtoplaylist"===result.command||"addtocollection"===result.command||(result.updated||result.deleted)&&notifyRefreshNeeded(card,itemsContainer)},onRejected)})})})}function onRejected(){}function executeAction(card,target,action){target=target||card;var item=getItemFromElement(card=dom.parentWithAttribute(card,"data-type")),serverId=item.ServerId,type=item.Type,playableItemId="Program"===type?item.ChannelId:item.Id;if("Photo"===item.MediaType&&"link"===action&&(action="play"),"link"===action)"AddVirtualFolder"===item.Type?function(card){card.dispatchEvent(new CustomEvent("addvirtualfolder",{cancelable:!1,bubbles:!0}))}(card):appRouter.showItem(item,{context:card.getAttribute("data-context"),parentId:card.getAttribute("data-parentid")});else if("programlink"===action){var program=item.CurrentProgram||item;appRouter.showItem(program.Id,item.ServerId)}else if("programdialog"===action)!function(item){require(["recordingCreator"],function(recordingCreator){recordingCreator.show(item.Id,item.ServerId)})}(item);else if("instantmix"===action)playbackManager.instantMix({Id:playableItemId,ServerId:serverId});else if("play"===action||"playpause"===action||"resume"===action)playbackManager.play({ids:[playableItemId],serverId:serverId,startPositionTicks:item.StartPositionTicks});else if("queue"===action)playbackManager.isPlaying()?(playbackManager.queue({ids:[playableItemId],serverId:serverId}),function(text){require(["toast"],function(toast){toast(text)})}(globalize.translate("MediaQueued"))):playbackManager.queue({ids:[playableItemId],serverId:serverId});else if("playallfromhere"===action)playAllFromHere(card,0,serverId);else if("queueallfromhere"===action)playAllFromHere(card,0,serverId,!0);else if("setplaylistindex"===action)playbackManager.setCurrentPlaylistItem(card.getAttribute("data-playlistitemid"));else if("record"===action)!function(serverId,id,type,timerId,timerStatus,seriesTimerId){if("Program"===type||timerId||seriesTimerId){var programId="Program"===type?id:null;recordingHelper.toggleRecording(serverId,programId,timerId,timerStatus,seriesTimerId)}}(serverId,item.Id,type,card.getAttribute("data-timerid"),card.getAttribute("data-status"),card.getAttribute("data-seriestimerid"));else if("menu"===action||"info"===action){var options="false"===target.getAttribute("data-playoptions")?{shuffle:!1,instantMix:!1,play:!1,playAllFromHere:!1,queue:!1,queueAllFromHere:!1}:{};options.positionTo=target,showContextMenu(card,options)}else if("edit"===action)!function(apiClient,item,button){(function(apiClient,item,button){var itemType=item.Type;return"Timer"===itemType?function(itemId,serverId){return connectionManager.getApiClient(serverId).getLiveTvTimer(itemId).then(function(item){return item.ProgramId?appRouter.showItem(item.ProgramId,serverId):require(["recordingEditor"]).then(function(objects){return objects[0].show(itemId,serverId)})})}(item.Id,item.ServerId):"VirtualFolder"===itemType?function(button){return getItem(button).then(function(item){var view=dom.parentWithClass(button,"page"),refreshLibrary=!!button&&"true"===view.getAttribute("data-refreshlibrary");return require(["medialibraryeditor"]).then(function(responses){return(new responses[0]).show({refresh:refreshLibrary,library:item})})})}(button):require(["metadataEditor"]).then(function(responses){return responses[0].show(item.Id,item.ServerId)})})(0,item,button).then(function(){notifyRefreshNeeded(button)})}(connectionManager.getApiClient(item),item,card);else if("playtrailer"===action)!function(itemId,serverId){var apiClient=connectionManager.getApiClient(serverId);apiClient.getLocalTrailers(apiClient.getCurrentUserId(),itemId).then(function(trailers){playbackManager.play({items:trailers})})}(item.Id,serverId);else if("addtoplaylist"===action)!function(itemId,serverId){require(["addToList"]).then(function(responses){return(new responses[0]).show({items:[itemId],serverId:serverId,type:"Playlist"})})}(item.Id,serverId);else if("multiselect"===action){dom.parentWithClass(card,"itemsContainer").showMultiSelect(dom.parentWithClass(card,"card"))}else if("custom"===action){var customAction=target.getAttribute("data-customaction");card.dispatchEvent(new CustomEvent("action-"+customAction,{detail:{playlistItemId:card.getAttribute("data-playlistitemid"),item:item},cancelable:!1,bubbles:!0}))}else"connecttoserver"===action?function(item){if("AddServer"===item.Type)return appRouter.showItem(item);if("EmbyConnect"===item.Type)return appRouter.showConnectLogin();loading.show(),item=connectionManager.getServerInfo(item.Id)||item,connectionManager.connectToServer(item,{enableAutoLogin:appSettings.enableAutoLogin()}).then(function(result){appRouter.handleConnectionResult(result)})}(item):"overview"===action&&function(item){!function(options){require(["alert"]).then(function(responses){responses[0](options)})}(dom.stripScripts(item.Overview||""))}(item)}function onClick(e){var card=dom.parentWithClass(e.target,"itemAction");if(card){var actionElement=card,action=actionElement.getAttribute("data-action");if(action||(actionElement=dom.parentWithAttribute(actionElement,"data-action"))&&(action=actionElement.getAttribute("data-action")),action&&(executeAction(card,actionElement,action),"multiselect"!==action&&"openlink"!==action))return e.preventDefault(),e.stopPropagation(),!1}}function onCommand(e){var target,itemsContainer,scroller,cmd=e.detail.command;if("play"===cmd||"playpause"===cmd||"resume"===cmd||"record"===cmd||"menu"===cmd||"info"===cmd){target=e.target;var card=dom.parentWithClass(target,"itemAction")||dom.parentWithAttribute(target,"data-id");card&&(e.preventDefault(),e.stopPropagation(),executeAction(card,card,cmd))}else"pageup"===cmd?(target=e.target,(itemsContainer=dom.parentWithClass(target,"itemsContainer"))&&(scroller=dom.parentWithAttribute(itemsContainer,"is","emby-scroller"))&&"false"===scroller.getAttribute("data-horizontal")&&(itemsContainer.pageUp(target),e.preventDefault(),e.stopPropagation())):"pagedown"===cmd?(target=e.target,(itemsContainer=dom.parentWithClass(target,"itemsContainer"))&&(scroller=dom.parentWithAttribute(itemsContainer,"is","emby-scroller"))&&"false"===scroller.getAttribute("data-horizontal")&&(itemsContainer.pageDown(target),e.preventDefault(),e.stopPropagation())):"end"===cmd&&(target=e.target,(itemsContainer=dom.parentWithClass(target,"itemsContainer"))&&(scroller=dom.parentWithAttribute(itemsContainer,"is","emby-scroller"))&&"false"===scroller.getAttribute("data-horizontal")&&(itemsContainer.focusLast(),e.preventDefault(),e.stopPropagation()))}return{on:function(context,options){!1!==(options=options||{}).click&&context.addEventListener("click",onClick),!1!==options.command&&inputManager.on(context,onCommand)},off:function(context,options){options=options||{},context.removeEventListener("click",onClick),!1!==options.command&&inputManager.off(context,onCommand)},onClick:onClick,getShortcutAttributesHtml:function(item,options){var dataAttributes="",context=options.context;context&&(dataAttributes+=' data-context="'+context+'"');var parentId=options.parentId;parentId&&(dataAttributes+=' data-parentid="'+parentId+'"');var status=item.Status;status&&(dataAttributes+=' data-status="'+status+'"');var channelId=item.ChannelId;channelId&&(dataAttributes+=' data-channelid="'+channelId+'"');var type=item.Type;type&&(dataAttributes+=' data-type="'+type+'"');var mediaType=item.MediaType;mediaType&&(dataAttributes+=' data-mediatype="'+mediaType+'"'),options.collectionId?dataAttributes+=' data-collectionid="'+options.collectionId+'"':options.playlistId&&(dataAttributes+=' data-playlistid="'+options.playlistId+'"'),item.IsFolder&&(dataAttributes+=' data-isfolder="true"');var playlistItemId=item.PlaylistItemId;playlistItemId&&(dataAttributes+=' data-playlistitemid="'+playlistItemId+'"');var serverId=item.ServerId||options.serverId;serverId&&(dataAttributes+=' data-serverid="'+serverId+'"');var itemId=item.Id||item.ItemId;return itemId&&(dataAttributes+=' data-id="'+itemId+'"'),item.TimerId&&(dataAttributes+=' data-timerid="'+item.TimerId+'"'),item.SeriesTimerId&&(dataAttributes+=' data-seriestimerid="'+item.SeriesTimerId+'"'),dataAttributes},getShortcutAttributes:function(item,options){var dataAttributes=[],context=options.context;context&&dataAttributes.push({name:"data-context",value:context});var parentId=options.parentId;parentId&&dataAttributes.push({name:"data-parentid",value:parentId});var status=item.Status;status&&dataAttributes.push({name:"data-status",value:status});var channelId=item.ChannelId;channelId&&dataAttributes.push({name:"data-channelid",value:channelId});var type=item.Type;type&&dataAttributes.push({name:"data-type",value:type});var mediaType=item.MediaType;mediaType&&dataAttributes.push({name:"data-mediatype",value:mediaType}),options.collectionId?dataAttributes.push({name:"data-collectionid",value:options.collectionId}):options.playlistId&&dataAttributes.push({name:"data-playlistid",value:options.playlistId});var isFolder=item.IsFolder;null!=isFolder&&dataAttributes.push({name:"data-isfolder",value:isFolder.toString()});var playlistItemId=item.PlaylistItemId;playlistItemId&&dataAttributes.push({name:"data-playlistitemid",value:playlistItemId});var serverId=item.ServerId||options.serverId;serverId&&dataAttributes.push({name:"data-serverid",value:serverId});var itemId=item.Id||item.ItemId;return itemId&&dataAttributes.push({name:"data-id",value:itemId}),item.TimerId&&dataAttributes.push({name:"data-timerid",value:item.TimerId}),item.SeriesTimerId&&dataAttributes.push({name:"data-seriestimerid",value:item.SeriesTimerId}),dataAttributes}}});