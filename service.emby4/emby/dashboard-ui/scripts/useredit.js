define(["jQuery","loading","appRouter","globalize","emby-select","emby-linkbutton","emby-input","emby-checkbox","emby-button"],function($,loading,appRouter,globalize){"use strict";var currentUser;function loadUser(page,user){currentUser=user,ApiClient.getJSON(ApiClient.getUrl("Auth/Providers")).then(function(providers){!function(page,user,providers){1<providers.length&&!user.Policy.IsAdministrator?page.querySelector(".fldSelectLoginProvider").classList.remove("hide"):page.querySelector(".fldSelectLoginProvider").classList.add("hide");var currentProviderId=user.Policy.AuthenticationProviderId;page.querySelector(".selectLoginProvider").innerHTML=providers.map(function(provider){var selected=provider.Id===currentProviderId||providers.length<2?" selected":"";return'<option value="'+provider.Id+'"'+selected+">"+provider.Name+"</option>"})}(page,user,providers)}),ApiClient.getJSON(ApiClient.getUrl("Library/MediaFolders",{IsHidden:!1})).then(function(folders){!function(page,user,mediaFolders){ApiClient.getJSON(ApiClient.getUrl("Channels",{SupportsMediaDeletion:!0})).then(function(channelsResult){var i,length,folder,checkedAttribute,html="";for(i=0,length=mediaFolders.length;i<length;i++)folder=mediaFolders[i],checkedAttribute=user.Policy.EnableContentDeletion||-1!==user.Policy.EnableContentDeletionFromFolders.indexOf(folder.Id)?' checked="checked"':"",html+='<label><input type="checkbox" is="emby-checkbox" class="chkFolder" data-id="'+folder.Id+'" '+checkedAttribute+"><span>"+folder.Name+"</span></label>";for(i=0,length=channelsResult.Items.length;i<length;i++)folder=channelsResult.Items[i],checkedAttribute=user.Policy.EnableContentDeletion||-1!==user.Policy.EnableContentDeletionFromFolders.indexOf(folder.Id)?' checked="checked"':"",html+='<label><input type="checkbox" is="emby-checkbox" class="chkFolder" data-id="'+folder.Id+'" '+checkedAttribute+"><span>"+folder.Name+"</span></label>";$(".deleteAccess",page).html(html).trigger("create"),page.querySelector("#chkEnableDeleteAllFolders").checked=user.Policy.EnableContentDeletion,$(page.querySelector("#chkEnableDeleteAllFolders")).trigger("change")})}(page,user,folders.Items)}),user.Policy.IsDisabled?page.querySelector(".disabledUserBanner").classList.remove("hide"):page.querySelector(".disabledUserBanner").classList.add("hide"),$(".lnkEditUserPreferences",page).attr("href","settings?userId="+user.Id+"&serverId="+user.ServerId),appRouter.setTitle(user.Name),page.querySelector(".username").innerHTML=user.Name,$("#txtUserName",page).val(user.Name),$("#txtConnectUserName",page).val(currentUser.ConnectUserName),page.querySelector("#chkIsAdmin").checked=user.Policy.IsAdministrator,page.querySelector("#chkDisabled").checked=user.Policy.IsDisabled,page.querySelector("#chkIsHidden").checked=user.Policy.IsHidden,page.querySelector("#chkIsHiddenRemotely").checked=user.Policy.IsHiddenRemotely||!1,page.querySelector("#chkRemoteControlSharedDevices").checked=user.Policy.EnableSharedDeviceControl,page.querySelector("#chkEnableRemoteControlOtherUsers").checked=user.Policy.EnableRemoteControlOfOtherUsers,page.querySelector("#chkEnableDownloading").checked=user.Policy.EnableContentDownloading,page.querySelector("#chkEnableSubtitleDownloading").checked=user.Policy.EnableSubtitleDownloading||!1,page.querySelector("#chkEnableSubtitleManagement").checked=user.Policy.EnableSubtitleManagement||!1,page.querySelector("#chkManageLiveTv").checked=user.Policy.EnableLiveTvManagement,page.querySelector("#chkEnableLiveTvAccess").checked=user.Policy.EnableLiveTvAccess,page.querySelector("#chkEnableMediaPlayback").checked=user.Policy.EnableMediaPlayback,page.querySelector("#chkEnableAudioPlaybackTranscoding").checked=user.Policy.EnableAudioPlaybackTranscoding,page.querySelector("#chkEnableVideoPlaybackTranscoding").checked=user.Policy.EnableVideoPlaybackTranscoding,page.querySelector("#chkEnableVideoPlaybackRemuxing").checked=user.Policy.EnablePlaybackRemuxing,page.querySelector("#chkRemoteAccess").checked=null==user.Policy.EnableRemoteAccess||user.Policy.EnableRemoteAccess,page.querySelector("#chkAllowChangeProfile").checked=user.Policy.EnableUserPreferenceAccess,page.querySelector("#chkEnableSyncTranscoding").checked=user.Policy.EnableSyncTranscoding,page.querySelector("#chkEnableConversion").checked=user.Policy.EnableMediaConversion||!1,page.querySelector("#chkEnableSharing").checked=user.Policy.EnablePublicSharing,page.querySelector("#txtRemoteClientBitrateLimit").value=user.Policy.RemoteClientBitrateLimit/1e6||"",page.querySelector("#selectStreamLimit").value=user.Policy.SimultaneousStreamLimit||"0",loading.hide()}return function(page,params){function saveUser(user,page){user.Name=$("#txtUserName",page).val(),user.Policy.IsAdministrator=page.querySelector("#chkIsAdmin").checked,user.Policy.IsHidden=page.querySelector("#chkIsHidden").checked,user.Policy.IsHiddenRemotely=page.querySelector("#chkIsHiddenRemotely").checked,user.Policy.IsDisabled=page.querySelector("#chkDisabled").checked,user.Policy.EnableRemoteControlOfOtherUsers=page.querySelector("#chkEnableRemoteControlOtherUsers").checked,user.Policy.EnableLiveTvManagement=page.querySelector("#chkManageLiveTv").checked,user.Policy.EnableLiveTvAccess=page.querySelector("#chkEnableLiveTvAccess").checked,user.Policy.EnableSharedDeviceControl=page.querySelector("#chkRemoteControlSharedDevices").checked,user.Policy.EnableMediaPlayback=page.querySelector("#chkEnableMediaPlayback").checked,user.Policy.EnableAudioPlaybackTranscoding=page.querySelector("#chkEnableAudioPlaybackTranscoding").checked,user.Policy.EnableVideoPlaybackTranscoding=page.querySelector("#chkEnableVideoPlaybackTranscoding").checked,user.Policy.EnablePlaybackRemuxing=page.querySelector("#chkEnableVideoPlaybackRemuxing").checked,user.Policy.EnableSubtitleDownloading=page.querySelector("#chkEnableSubtitleDownloading").checked,user.Policy.EnableSubtitleManagement=page.querySelector("#chkEnableSubtitleManagement").checked,user.Policy.EnableContentDownloading=page.querySelector("#chkEnableDownloading").checked,user.Policy.EnableSyncTranscoding=page.querySelector("#chkEnableSyncTranscoding").checked,user.Policy.EnableMediaConversion=page.querySelector("#chkEnableConversion").checked,user.Policy.EnablePublicSharing=page.querySelector("#chkEnableSharing").checked,user.Policy.EnableRemoteAccess=page.querySelector("#chkRemoteAccess").checked,user.Policy.RemoteClientBitrateLimit=parseInt(1e6*parseFloat($("#txtRemoteClientBitrateLimit",page).val()||"0")),user.Policy.AuthenticationProviderId=page.querySelector(".selectLoginProvider").value,user.Policy.SimultaneousStreamLimit=page.querySelector("#selectStreamLimit").value,user.Policy.EnableUserPreferenceAccess=page.querySelector("#chkAllowChangeProfile").checked,user.Policy.EnableContentDeletion=page.querySelector("#chkEnableDeleteAllFolders").checked,user.Policy.EnableContentDeletionFromFolders=user.Policy.EnableContentDeletion?[]:$(".chkFolder",page).get().filter(function(c){return c.checked}).map(function(c){return c.getAttribute("data-id")}),ApiClient.updateUser(user).then(function(){ApiClient.updateUserPolicy(user.Id,user.Policy).then(function(){!function(page,user){loading.hide(),(currentUser.ConnectUserName||"")===$("#txtConnectUserName",page).val()?require(["toast"],function(toast){toast(globalize.translate("SettingsSaved"))}):require(["connectHelper"],function(connectHelper){connectHelper.updateUserLink(ApiClient,user,$("#txtConnectUserName",page).val()).then(function(){loadData(page)})})}(page,user)})})}function onSubmit(){var page=$(this).parents(".page")[0];return loading.show(),getUser().then(function(result){saveUser(result,page)}),!1}function getUser(){var userId=params.userId;return ApiClient.getUser(userId)}function loadData(page){loading.show(),getUser().then(function(user){loadUser(page,user)})}ApiClient.isMinServerVersion("4.3.0.9")&&page.querySelector(".fldStreamLimit").classList.remove("hide"),function(view){for(var html='<option value="0">'+globalize.translate("Unlimited")+"</option>",i=1;i<=50;i++)html+='<option value="'+i+'">'+i+"</option>";view.querySelector("#selectStreamLimit").innerHTML=html}(page),page.querySelector(".streamLimitPremiereInfo").innerHTML=globalize.translate("FeatureRequiresEmbyPremiere",'<a href="https://emby.media/premiere" data-preset="premiereinfo" is="emby-linkbutton" type="button" class="button-link">',"</a>"),$(".editUserProfileForm").off("submit",onSubmit).on("submit",onSubmit),page.querySelector(".sharingHelp").innerHTML=globalize.translate("OptionAllowLinkSharingHelp",30),$("#chkEnableDeleteAllFolders",page).on("change",function(){this.checked?$(".deleteAccess",page).hide():$(".deleteAccess",page).show()}),ApiClient.getServerConfiguration().then(function(config){config.EnableRemoteAccess?page.querySelector(".fldRemoteAccess").classList.remove("hide"):page.querySelector(".fldRemoteAccess").classList.add("hide")});for(var userId=params.userId,btns=page.querySelectorAll(".userEditTabButton"),i=0,length=btns.length;i<length;i++)btns[i].href=btns[i].getAttribute("data-href")+"?userId="+userId+"&serverId="+ApiClient.serverId();page.addEventListener("viewshow",function(){loadData(this)})}});