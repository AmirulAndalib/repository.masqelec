define(["layoutManager","loading","globalize","require","events","connectionManager","cardBuilder","appRouter","emby-scroller","emby-itemscontainer","emby-linkbutton"],function(layoutManager,loading,globalize,require,events,connectionManager,cardBuilder,appRouter){"use strict";function search(instance,apiClient,context,value){value||layoutManager.tv?(instance.mode="search",context.querySelector(".searchSuggestions").classList.add("hide")):(instance.mode="suggestions",function(instance,context,apiClient){var options={SortBy:"IsFavoriteOrLiked,Random",IncludeItemTypes:"Movie,Series,MusicArtist",Limit:20,Recursive:!0,ImageTypeLimit:0,EnableImages:!1,ParentId:instance.options.parentId,EnableTotalRecordCount:!1};apiClient.getItems(apiClient.getCurrentUserId(),options).then(function(result){"suggestions"!==instance.mode&&(result.Items=[]);var html=result.Items.map(function(i){var itemHtml='<div><a is="emby-linkbutton" class="button-link" style="display:inline-block;padding:.5em 1em;" href="'+appRouter.getRouteUrl(i)+'">';return itemHtml+=i.Name,itemHtml+="</a></div>"}).join(""),searchSuggestions=context.querySelector(".searchSuggestions");searchSuggestions.querySelector(".searchSuggestionsList").innerHTML=html,result.Items.length&&searchSuggestions.classList.remove("hide")})}(instance,context,apiClient));var promises=[];return"livetv"===instance.options.collectionType?promises.push(searchType(instance,apiClient,{searchTerm:value,IncludePeople:!1,IncludeMedia:!0,IncludeGenres:!1,IncludeStudios:!1,IncludeArtists:!1,IncludeItemTypes:"LiveTvProgram",IsMovie:!0,IsKids:!1},context,".movieResults",{shape:"autooverflow",showParentTitle:!0,showTitle:!0,centerText:!0,overlayText:!1,overlayMoreButton:!0,showAirTime:!0,showAirDateTime:!0,lines:3})):promises.push(searchType(instance,apiClient,{searchTerm:value,IncludePeople:!1,IncludeMedia:!0,IncludeGenres:!1,IncludeStudios:!1,IncludeArtists:!1,IncludeItemTypes:"Movie"},context,".movieResults",{showTitle:!0,overlayText:!1,centerText:!0,showYear:!0})),promises.push(searchType(instance,apiClient,{searchTerm:value,IncludePeople:!1,IncludeMedia:!0,IncludeGenres:!1,IncludeStudios:!1,IncludeArtists:!1,IncludeItemTypes:"Series"},context,".seriesResults",{showTitle:!0,overlayText:!1,centerText:!0,showYear:!0})),"livetv"===instance.options.collectionType?promises.push(searchType(instance,apiClient,{searchTerm:value,IncludePeople:!1,IncludeMedia:!0,IncludeGenres:!1,IncludeStudios:!1,IncludeArtists:!1,IncludeItemTypes:"LiveTvProgram",IsSeries:!0,IsSports:!1,IsKids:!1,IsNews:!1},context,".episodeResults",{shape:"autooverflow",showParentTitle:!0,showTitle:!0,centerText:!0,overlayText:!1,overlayMoreButton:!0,showAirTime:!0,showAirDateTime:!0,lines:3})):promises.push(searchType(instance,apiClient,{searchTerm:value,IncludePeople:!1,IncludeMedia:!0,IncludeGenres:!1,IncludeStudios:!1,IncludeArtists:!1,IncludeItemTypes:"Episode"},context,".episodeResults",{showTitle:!0,showParentTitle:!0})),promises.push(searchType(instance,apiClient,{searchTerm:value,IncludePeople:!1,IncludeMedia:!0,IncludeGenres:!1,IncludeStudios:!1,IncludeArtists:!1,IncludeItemTypes:"livetv"===instance.options.collectionType?"LiveTvProgram":"NullType",IsSports:!0},context,".sportsResults",{shape:"autooverflow",showParentTitle:!0,showTitle:!0,centerText:!0,overlayText:!1,overlayMoreButton:!0,showAirTime:!0,showAirDateTime:!0,lines:3})),promises.push(searchType(instance,apiClient,{searchTerm:value,IncludePeople:!1,IncludeMedia:!0,IncludeGenres:!1,IncludeStudios:!1,IncludeArtists:!1,IncludeItemTypes:"livetv"===instance.options.collectionType?"LiveTvProgram":"NullType",IsKids:!0},context,".kidsResults",{shape:"autooverflow",showParentTitle:!0,showTitle:!0,centerText:!0,overlayText:!1,overlayMoreButton:!0,showAirTime:!0,showAirDateTime:!0})),promises.push(searchType(instance,apiClient,{searchTerm:value,IncludePeople:!1,IncludeMedia:!0,IncludeGenres:!1,IncludeStudios:!1,IncludeArtists:!1,IncludeItemTypes:"livetv"===instance.options.collectionType?"LiveTvProgram":"NullType",IsNews:!0},context,".newsResults",{shape:"autooverflow",showParentTitle:!0,showTitle:!0,centerText:!0,overlayText:!1,overlayMoreButton:!0,showAirTime:!0,showAirDateTime:!0,lines:3})),promises.push(searchType(instance,apiClient,{searchTerm:value,IncludePeople:!1,IncludeMedia:!0,IncludeGenres:!1,IncludeStudios:!1,IncludeArtists:!1,IncludeItemTypes:"LiveTvProgram",IsMovie:"livetv"!==instance.options.collectionType&&null,IsSeries:"livetv"!==instance.options.collectionType&&null,IsSports:"livetv"!==instance.options.collectionType&&null,IsKids:"livetv"!==instance.options.collectionType&&null,IsNews:"livetv"!==instance.options.collectionType&&null},context,".programResults",{shape:"autooverflow",showParentTitle:!0,showTitle:!0,centerText:!0,overlayText:!1,showAirTime:!0,showAirDateTime:!0,lines:3})),promises.push(searchType(instance,apiClient,{searchTerm:value,IncludePeople:!1,IncludeMedia:!0,IncludeGenres:!1,IncludeStudios:!1,IncludeArtists:!1,IncludeItemTypes:"Video"},context,".videoResults",{showParentTitle:!0,showTitle:!0,overlayText:!1,centerText:!0})),promises.push(searchType(instance,apiClient,{searchTerm:value,IncludePeople:!1,IncludeMedia:!0,IncludeGenres:!1,IncludeStudios:!1,IncludeArtists:!1,IncludeItemTypes:"MusicVideo"},context,".musicVideoResults",{showParentTitle:!0,showTitle:!0,overlayText:!1,centerText:!0})),promises.push(promises.push(searchType(instance,apiClient,{searchTerm:value,IncludePeople:!1,IncludeMedia:!0,IncludeGenres:!1,IncludeStudios:!1,IncludeArtists:!1,IncludeItemTypes:"TvChannel"},context,".channelResults",{showParentTitle:!1,showTitle:!0,overlayText:!1,showCurrentProgramParentTitle:!0,showCurrentProgramTime:!0,centerText:!0,lines:3,defaultBackground:!0}))),promises.push(promises.push(searchType(instance,apiClient,{searchTerm:value,IncludePeople:!0,IncludeMedia:!1,IncludeGenres:!1,IncludeStudios:!1,IncludeArtists:!1},context,".peopleResults",{showTitle:!0}))),promises.push(promises.push(searchType(instance,apiClient,{searchTerm:value,IncludeTags:!0,IncludeMedia:!1,IncludeGenres:!1,IncludeStudios:!1,IncludeArtists:!1},context,".tagResults",{showTitle:!0,defaultBackground:!0,multiSelect:!1}))),promises.push(searchType(instance,apiClient,{searchTerm:value,IncludePeople:!1,IncludeMedia:!1,IncludeGenres:!1,IncludeStudios:!1,IncludeArtists:!0},context,".artistResults",{showTitle:!0})),promises.push(searchType(instance,apiClient,{searchTerm:value,IncludePeople:!1,IncludeMedia:!0,IncludeGenres:!1,IncludeStudios:!1,IncludeArtists:!1,IncludeItemTypes:"MusicAlbum"},context,".albumResults",{showParentTitle:!0,showTitle:!0,overlayText:!1,centerText:!0})),promises.push(searchType(instance,apiClient,{searchTerm:value,IncludePeople:!1,IncludeMedia:!0,IncludeGenres:!1,IncludeStudios:!1,IncludeArtists:!1,IncludeItemTypes:"Audio"},context,".songResults",{showParentTitle:!0,preferArtistTitle:!0,showTitle:!0,overlayText:!1,centerText:!0,action:"play"})),promises.push(searchType(instance,apiClient,{searchTerm:value,IncludePeople:!1,IncludeMedia:!0,IncludeGenres:!1,IncludeStudios:!1,IncludeArtists:!1,IncludeItemTypes:"Photo"},context,".photoResults",{showParentTitle:!1,showTitle:!0,overlayText:!1,centerText:!0})),promises.push(searchType(instance,apiClient,{searchTerm:value,IncludePeople:!1,IncludeMedia:!0,IncludeGenres:!1,IncludeStudios:!1,IncludeArtists:!1,IncludeItemTypes:"PhotoAlbum"},context,".photoAlbumResults",{showTitle:!0,overlayText:!1,centerText:!0})),promises.push(searchType(instance,apiClient,{searchTerm:value,IncludePeople:!1,IncludeMedia:!0,IncludeGenres:!1,IncludeStudios:!1,IncludeArtists:!1,IncludeItemTypes:"Book"},context,".bookResults",{showTitle:!0,overlayText:!1,centerText:!0})),promises.push(searchType(instance,apiClient,{searchTerm:value,IncludePeople:!1,IncludeMedia:!0,IncludeGenres:!1,IncludeStudios:!1,IncludeArtists:!1,IncludeItemTypes:"Game"},context,".gameResults",{showTitle:!0,overlayText:!1,centerText:!0})),promises.push(searchType(instance,apiClient,{searchTerm:value,IncludePeople:!1,IncludeMedia:!0,IncludeGenres:!1,IncludeStudios:!1,IncludeArtists:!1,IncludeItemTypes:"Playlist"},context,".playlistResults",{showTitle:!0,overlayText:!1,centerText:!0})),promises.push(searchType(instance,apiClient,{searchTerm:value,IncludePeople:!1,IncludeMedia:!0,IncludeGenres:!1,IncludeStudios:!1,IncludeArtists:!1,IncludeItemTypes:"BoxSet"},context,".collectionResults",{showTitle:!0,overlayText:!1,centerText:!0})),Promise.all(promises)}function searchType(instance,apiClient,query,context,section,cardOptions){return query.Limit=16,query.ParentId=instance.options.parentId,function(instance,apiClient,query){if(!query.searchTerm)return Promise.resolve({SearchHints:[]});var allowSearch=!0,queryIncludeItemTypes=query.IncludeItemTypes;if("tvshows"===instance.options.collectionType?query.IncludeArtists?allowSearch=!1:"Movie"!==queryIncludeItemTypes&&"LiveTvProgram"!==queryIncludeItemTypes&&"MusicAlbum"!==queryIncludeItemTypes&&"Audio"!==queryIncludeItemTypes&&"Book"!==queryIncludeItemTypes&&"Game"!==queryIncludeItemTypes&&"BoxSet"!==queryIncludeItemTypes&&"Playlist"!==queryIncludeItemTypes&&"PhotoAlbum"!==queryIncludeItemTypes&&"TvChannel"!==queryIncludeItemTypes&&"Video"!==queryIncludeItemTypes&&"MusicVideo"!==queryIncludeItemTypes&&"Photo"!==queryIncludeItemTypes||(allowSearch=!1):"movies"===instance.options.collectionType?query.IncludeArtists?allowSearch=!1:"Series"!==queryIncludeItemTypes&&"Episode"!==queryIncludeItemTypes&&"LiveTvProgram"!==queryIncludeItemTypes&&"MusicAlbum"!==queryIncludeItemTypes&&"Audio"!==queryIncludeItemTypes&&"Book"!==queryIncludeItemTypes&&"Game"!==queryIncludeItemTypes&&"BoxSet"!==queryIncludeItemTypes&&"Playlist"!==queryIncludeItemTypes&&"PhotoAlbum"!==queryIncludeItemTypes&&"TvChannel"!==queryIncludeItemTypes&&"Video"!==queryIncludeItemTypes&&"MusicVideo"!==queryIncludeItemTypes&&"Photo"!==queryIncludeItemTypes||(allowSearch=!1):"music"===instance.options.collectionType?query.People?allowSearch=!1:"Series"!==queryIncludeItemTypes&&"Episode"!==queryIncludeItemTypes&&"LiveTvProgram"!==queryIncludeItemTypes&&"TvChannel"!==queryIncludeItemTypes&&"Movie"!==queryIncludeItemTypes||(allowSearch=!1):"livetv"===instance.options.collectionType&&(query.IncludeArtists||query.IncludePeople?allowSearch=!1:"Series"!==queryIncludeItemTypes&&"Episode"!==queryIncludeItemTypes&&"MusicAlbum"!==queryIncludeItemTypes&&"Audio"!==queryIncludeItemTypes&&"Book"!==queryIncludeItemTypes&&"Game"!==queryIncludeItemTypes&&"PhotoAlbum"!==queryIncludeItemTypes&&"Movie"!==queryIncludeItemTypes&&"BoxSet"!==queryIncludeItemTypes&&"Playlist"!==queryIncludeItemTypes&&"Video"!==queryIncludeItemTypes&&"MusicVideo"!==queryIncludeItemTypes&&"Photo"!==queryIncludeItemTypes||(allowSearch=!1)),"NullType"===queryIncludeItemTypes&&(allowSearch=!1),!allowSearch)return Promise.resolve({SearchHints:[]});query.Fields="PrimaryImageAspectRatio,CanDelete,BasicSyncInfo,ProductionYear","Series"===queryIncludeItemTypes&&(query.Fields+=",Status,EndDate"),query.Recursive=!0,query.EnableTotalRecordCount=!1,query.ImageTypeLimit=1;var methodName="getItems";return query.IncludeMedia||(query.IncludePeople?methodName="getPeople":query.IncludeArtists?methodName="getArtists":query.IncludeTags&&(methodName="getTags")),apiClient[methodName](apiClient.getCurrentUserId(),query)}(instance,apiClient,query).then(function(result){return function(result,context,section,cardOptions){section=context.querySelector(section);var items=result.Items||result.SearchHints,itemsContainer=section.querySelector(".itemsContainer");return cardBuilder.buildCards(items,Object.assign({itemsContainer:itemsContainer,parentContainer:section,shape:"autooverflow",scalable:!0,overlayText:!1,centerText:!0},cardOptions||{})),section.querySelector(".emby-scroller").scrollToBeginning(!0),items}(result,context,section,cardOptions)})}function SearchResults(options){!function(elem,instance){elem.classList.add("searchResults"),instance.search("")}((this.options=options).element,this)}return SearchResults.prototype.search=function(value){loading.show();var apiClient=connectionManager.getApiClient(this.options.serverId),elem=this.options.element;elem.querySelector(".noResults").classList.add("hide");var searchInfo={instance:this,searchTerm:value};search(this,apiClient,elem,value).then(function(itemsResponses){loading.hide();var options=this.instance.options;if(options){for(var hasResults,i=0,length=itemsResponses.length;i<length;i++)if(itemsResponses[i].length){hasResults=!0;break}var noResultsElem=options.element.querySelector(".noResults");hasResults||!this.searchTerm?noResultsElem.classList.add("hide"):(this.searchTerm.length<2?noResultsElem.innerHTML=globalize.translate("TwoSearchCharsRequired"):noResultsElem.innerHTML=globalize.translate("NoItemsMatchingFound"),noResultsElem.classList.remove("hide"))}}.bind(searchInfo),function(){loading.hide();var options=this.options;options&&options.element.querySelector(".noResults").classList.remove("hide")}.bind(this))},SearchResults.prototype.destroy=function(){var options=this.options;options&&options.element.classList.remove("searchFields"),this.options=null},SearchResults});